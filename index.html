<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Snag Tracker</title>
    <!-- Favicon (Construction Hat Icon) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%231E40AF'%3E%3Cpath d='M10.87 2.15a2 2 0 0 0-2.73.43L2 14.59v4.25c0 1.25.75 1.58 1.9 1.58h15.98c1.15 0 1.9-.33 1.9-1.58V14.59l-6.14-12.01a2 2 0 0 0-2.73-.43Z'/%3E%3Cpath fill='%2310B981' d='M12 21a1 1 0 0 0 0-2c-3.1 0-5.83-2.14-6.49-5h-1.02c.88 4 4.54 7 8.51 7Zm2.5-4a.5.5 0 1 0-1 0v.5h1z'/%3E%3C/svg%3E" type="image/svg+xml">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1E40AF', // Blue-800
                        'accent': '#10B981',  // Green-500
                        'status-open': '#F59E0B', // Amber-500
                        'status-closed': '#10B981', // Green-500
                    }
                }
            }
        }
    </script>
    <!-- React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Custom styles for the sleek look */
        html, body, #root {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column; 
        }

        /* Base Mobile (Single Column) */
        .main-content { 
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr; 
            overflow: hidden;
            position: relative; /* Needed for absolute positioning of mobile panels */
        }
        
        .panel {
            padding: 0;
            background-color: white;
            display: flex;
            flex-direction: column;
            overflow-y: hidden; 
            /* Mobile: Absolute position for smooth transitions */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease-in-out, z-index 0s;
            z-index: 10;
        }

        /* Panel transitions for mobile sliding effect */
        .panel.hidden-right { transform: translateX(100%); z-index: 5; }
        .panel.active-panel { transform: translateX(0); z-index: 15; }

        /* Desktop (lg breakpoint) 3-Column Layout FIX */
        @media (min-width: 1024px) {
            .main-content {
                /* Define 3 columns explicitly and ensure it uses grid */
                display: grid; 
                grid-template-columns: minmax(200px, 1.5fr) minmax(250px, 2fr) minmax(350px, 4fr);
            }
            .panel {
                /* CRITICAL FIX: Reset absolute positioning so grid takes over */
                position: relative !important; 
                z-index: 1;
                border-right: 1px solid #E2E8F0; /* slate-200 */
                /* Reset mobile transforms */
                transform: none !important;
                width: auto; /* Reset explicit width from mobile */
                height: auto; /* Reset explicit height from mobile */
            }
            .items-panel {
                 border-right: none; /* Last panel shouldn't have a right border */
            }
        }

        .panel-list-wrapper { /* General purpose wrapper for scrollable lists */
            flex-grow: 1;
            overflow-y: auto;
        }

        .snag-card {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            cursor: default;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 450px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        .snag-description a {
            color: #2563EB; 
            text-decoration: underline;
            font-weight: 600;
            word-break: break-word;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div id="root" class="app-container"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        
        // --- CONFIGURATION ---
        const APP_VERSION = '12.4 (Desktop Layout Fixed)'; // Updated version
        const TABLE_NAME = 'snags';
        const CATEGORY_STORAGE_KEY = 'snag_projects_v11_3'; // Old localStorage key (for migration only)
        
        // NEW CONFIG for DB structure storage
        const STRUCTURE_TABLE = 'app_structure';
        const STRUCTURE_ROW_ID = 'project_room_map_v1';
        
        // !!! IMPORTANT: Supabase URL has been pasted below. Please replace the ANON KEY placeholder !!!
        const SUPABASE_URL = 'https://ejozspveaasscxqovitn.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqb3pzcHZlYWFzc2N4cW92aXRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzMyOTcsImV4cCI6MjA3NjAwOTI5N30.D--chXcvpMl_gDRY0ZvBcAg3nzwwDAuuFHTB2pgYtZ8';
        // --- END CONFIGURATION ---
        
        // Initial setup data (Set to empty {} for a blank canvas start)
        const INITIAL_PROJECTS = {};

        // --- ICONS (Lucide React equivalent SVGs) ---
        const X = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>;
        const Check = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6L9 17l-5-5"/></svg>;
        const Trash = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 4h4V2h-4z"/></svg>;
        const Edit = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5L2 22l1.5-5.5L17 3z"/></svg>;
        const Plus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>;
        const Camera = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>;
        const LinkIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>;
        const LayoutGrid = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>;
        const ArrowLeft = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19l-7-7 7-7"/><path d="M19 12H5"/></svg>;


        // --- UTILITY FUNCTIONS (Database Structure Management) ---

        // Function to attempt loading legacy projects from localStorage for migration
        const loadLegacyProjects = () => {
            try {
                const stored = localStorage.getItem(CATEGORY_STORAGE_KEY);
                return stored ? JSON.parse(stored) : null;
            } catch (e) {
                console.error("Error loading legacy projects from localStorage:", e);
                return null;
            }
        };

        const getStructureFromDB = async (client) => {
            if (!client) return null;
            try {
                const { data, error } = await client
                    .from(STRUCTURE_TABLE)
                    .select('structure_map')
                    .eq('id', STRUCTURE_ROW_ID)
                    .single();

                // PGRST116 means 'no row found' (which is expected if it's the first time)
                if (error && error.code !== 'PGRST116') { 
                    console.warn("DB Structure Fetch Warning:", error.message);
                }
                return data?.structure_map || null;

            } catch (e) {
                console.error("Error fetching structure from DB:", e);
                return null;
            }
        };

        const saveStructureToDB = async (client, map) => {
            if (!client) return false;
            try {
                // Use upsert to insert if not exists, or update if exists
                const { error } = await client
                    .from(STRUCTURE_TABLE)
                    .upsert({ id: STRUCTURE_ROW_ID, structure_map: map }, { onConflict: 'id' });

                if (error) {
                    console.error("Error saving structure to DB:", error);
                    return false;
                }
                return true;
            } catch (e) {
                console.error("Error saving structure to DB:", e);
                return false;
            }
        };
        
        // Updated to accept count for reporting
        const clearAllSnagsFromDB = async (client, count) => {
            if (!client) {
                console.error('Client not ready for clearing database.');
                return;
            }
            
            // Delete all rows in the snags table using a dummy condition that is always true for existing IDs
            const { error } = await client
                .from(TABLE_NAME)
                .delete()
                .neq('id', '0'); 

            if (error) {
                console.error("Error clearing all snags:", error);
                // Set status here, but the fetchSnags will overwrite it if successful
            } else {
                // Status is set after fetchSnags completes to confirm data is empty
            }
        };


        const renderMarkdownLinks = (text) => {
            if (!text) return { __html: '' };
            const regex = /\[([^\]]+)\]\(([^)]+)\)/g;
            
            const htmlText = text.replace(regex, (match, linkText, url) => {
                let safeUrl = url.trim();
                if (!safeUrl.match(/^(https?:\/\/|mailto:)/i)) {
                    safeUrl = 'http://' + safeUrl;
                }
                return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
            });

            return { __html: htmlText };
        };


        function Tracker() {
            const [snags, setSnags] = useState([]);
            
            // Structure Management State: Initialized to empty map, actual loading happens in useEffect
            const [allGroupsMap, setAllGroupsMap] = useState({});
            const allProjects = useMemo(() => Object.keys(allGroupsMap).sort(), [allGroupsMap]);

            // UI State for the navigation
            const [selectedProject, setSelectedProject] = useState('');
            const [selectedGroup, setSelectedGroup] = useState('');
            
            // MOBILE State: 'projects', 'groups', 'items'
            const [activePanel, setActivePanel] = useState('projects'); 
            const [isDesktop, setIsDesktop] = useState(window.innerWidth >= 1024);
            
            // System State
            const [status, setStatus] = useState('Awaiting connection...');
            const [supabaseClient, setSupabaseClient] = useState(null);
            
            // Modals and Forms
            const [modal, setModal] = useState(null); 
            const [linkModal, setLinkModal] = useState(null); 
            const [isAddSnagModalOpen, setIsAddSnagModalOpen] = useState(false); 
            const [viewingPhoto, setViewingPhoto] = useState(null);
            const [newProjectCategory, setNewProjectCategory] = useState('');
            const [newProjectGroup, setNewProjectGroup] = useState('');
            const [editingSnagId, setEditingSnagId] = useState(null);
            const [editingSnagText, setEditingSnagText] = useState('');
            const [editingProjectCategory, setEditingProjectCategory] = useState('');
            const [editingProjectGroup, setEditingProjectGroup] = useState('');
            
            
            const totalSnagsCount = snags.length;
            const isClearDbVisible = allProjects.length === 0 && !!supabaseClient;


            useEffect(() => {
                const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);


            // --- SUPABASE INITIALIZATION & LISTENER ---

            useEffect(() => {
                if (SUPABASE_ANON_KEY.includes('PASTE_')) {
                    setStatus('Error: Supabase ANONYMOUS KEY is missing. Please enter it in the CONFIGURATION section.');
                    return;
                }
                
                try {
                    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    setSupabaseClient(client);
                    setStatus('Client initialized...');
                } catch (error) {
                    console.error("Supabase Initialization Error:", error);
                    setStatus(`Initialization Error: ${error.message}`);
                }
            }, []);

            const fetchSnags = useCallback(async (client) => {
                if (!client) return;

                setStatus('Fetching structure and data...');
                
                // --- 1. Fetch Structure from DB (or migrate if necessary) ---
                let structureMap = await getStructureFromDB(client); 
                
                if (!structureMap) {
                    // Try to migrate from old local storage
                    const localData = loadLegacyProjects();
                    if (localData && Object.keys(localData).length > 0) {
                        structureMap = localData;
                        console.log("Migrating local structure to Supabase...");
                        setStatus('Migrating project structure...');
                    } else {
                        // Use the empty template for a blank canvas start if no data is found locally or in DB
                        structureMap = INITIAL_PROJECTS;
                    }

                    // Upload the final chosen structure (local data or template) to the DB for the first time
                    if (await saveStructureToDB(client, structureMap)) {
                        // Clear local storage once successfully migrated/initialized to prevent future attempts
                        localStorage.removeItem(CATEGORY_STORAGE_KEY);
                        console.log("Project structure initialized in Supabase.");
                    }
                }
                
                // Set the current state map
                setAllGroupsMap(structureMap);


                // --- 2. Fetch Snags ---
                const { data, error } = await client
                    .from(TABLE_NAME)
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error("Fetch Snags Error:", error);
                    setStatus(`Error fetching data: ${error.message}`);
                    return;
                }

                setSnags(data);
                setStatus(`Sync successful. ${data.length} items. Structure synced.`);

                // --- 3. Update Selections and Defaults ---
                const projects = Object.keys(structureMap).sort();
                
                let projectToSelect = selectedProject;
                let groupToSelect = selectedGroup;

                if (!projectToSelect || !projects.includes(projectToSelect)) {
                    projectToSelect = projects[0] || '';
                } 

                if (projectToSelect) {
                    const currentGroups = structureMap[projectToSelect] || [];
                    if (!groupToSelect || !currentGroups.includes(groupToSelect)) {
                        groupToSelect = currentGroups[0] || '';
                    }
                } else {
                    groupToSelect = '';
                }

                setSelectedProject(projectToSelect);
                setSelectedGroup(groupToSelect);
                
                const firstProj = projects[0] || '';
                setNewProjectCategory(firstProj);
                setNewProjectGroup(structureMap[firstProj]?.[0] || '');

            }, [selectedProject, selectedGroup]); 
            // Dependency 'allGroupsMap' removed because we are setting it here.

            useEffect(() => {
                if (!supabaseClient) return;
                
                fetchSnags(supabaseClient);

                // Listen to Snags table changes
                const snagSubscription = supabaseClient
                    .channel('public:snags_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: TABLE_NAME }, payload => {
                        fetchSnags(supabaseClient);
                    })
                    .subscribe();

                // Listen to Structure table changes (for multi-user sync)
                const structureSubscription = supabaseClient
                    .channel('public:structure_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: STRUCTURE_TABLE }, payload => {
                        console.log("Structure updated in DB, re-fetching...");
                        fetchSnags(supabaseClient);
                    })
                    .subscribe();


                return () => {
                    if (snagSubscription) {
                        supabaseClient.removeChannel(snagSubscription);
                    }
                    if (structureSubscription) {
                         supabaseClient.removeChannel(structureSubscription);
                    }
                };
            }, [supabaseClient, fetchSnags]);


            // --- STRUCTURE MANAGEMENT (PROJECTS & GROUPS) ---

            const structureAction = (type, action, currentName = '', parentProject = '') => {
                
                const handleStructureChange = async (newName) => {
                    const newMap = JSON.parse(JSON.stringify(allGroupsMap));
                    let shouldResetSelection = false;
                    
                    if (type === 'project') {
                        if (action === 'add' && newName) {
                            newMap[newName] = [];
                        } else if (action === 'edit' && newName && newName !== currentName) {
                            newMap[newName] = newMap[currentName] || [];
                            delete newMap[currentName];
                            if (selectedProject === currentName) {
                                setSelectedProject(newName); // Keep the new selection
                            }
                        } else if (action === 'delete') {
                            delete newMap[currentName];
                            // Force selection update on delete
                            setSelectedProject('');
                            setSelectedGroup('');
                            shouldResetSelection = true;
                        }
                    } else if (type === 'group' && parentProject) {
                        let groups = newMap[parentProject] || [];
                        
                        if (action === 'add' && newName) {
                            if (!groups.includes(newName)) groups.push(newName);
                        } else if (action === 'edit' && newName && newName !== currentName) {
                            const index = groups.indexOf(currentName);
                            if (index !== -1) groups[index] = newName;
                            if (selectedGroup === currentName) {
                                setSelectedGroup(newName); // Keep the new selection
                            }
                        } else if (action === 'delete') {
                            newMap[parentProject] = groups.filter(s => s !== currentName);
                            // Force group update on delete
                            if (currentName === selectedGroup) {
                                setSelectedGroup('');
                                shouldResetSelection = true;
                            }
                        }
                        // Sort for cleanliness
                        newMap[parentProject].sort();
                    }
                    
                    // 1. Update local state immediately for responsiveness
                    setAllGroupsMap(newMap);
                    
                    // 2. Save to database
                    setStatus('Saving structure to database...');
                    const success = await saveStructureToDB(supabaseClient, newMap);
                    
                    if (!success) {
                        setStatus('Error: Failed to save project structure to database.');
                    } else {
                        setStatus('Structure saved. Syncing...');
                    }
                    
                    // 3. Trigger re-fetch to ensure all components are synced and filters are reset correctly
                    if (shouldResetSelection) {
                         fetchSnags(supabaseClient);
                    }
                }

                // If deleting, show the confirm modal first
                if (action === 'delete') {
                    const structureName = type === 'group' ? 'Room' : 'Project';
                    const message = `Are you sure you want to delete the ${structureName.toLowerCase()} **${currentName}**? 
                                    This will permanently remove it from the synced structure for all users. 
                                    Note: The actual snag items in the database will NOT be deleted and will become orphaned.`;
                    
                    setModal({
                        type: 'confirm',
                        message: message,
                        action: () => handleStructureChange(currentName) // The handler knows to delete if currentName is passed
                    });
                } else {
                    // For add/edit, show the input modal
                     setModal({
                        type: 'structure',
                        actionType: action, // 'add', 'edit', 'delete'
                        structureType: type, // 'project', 'group'
                        currentName: currentName,
                        parentProject: parentProject,
                        handler: handleStructureChange
                    });
                }
            };


            // --- SUPABASE CRUD WRAPPERS ---
            const addNewSnagToDB = async (snagData) => {
                if (!supabaseClient) return setStatus('Connection not ready.');
                
                const { error } = await supabaseClient
                    .from(TABLE_NAME)
                    .insert([{ 
                        ...snagData,
                        status: 'open',
                        created_at: new Date().toISOString(),
                        photo_data: null, 
                    }]);

                if (error) {
                    console.error("Error adding item:", error);
                    setStatus(`Failed to add item: ${error.message}`);
                } else {
                    await fetchSnags(supabaseClient); 
                    setStatus('Item added successfully. Syncing...');
                    
                    setIsAddSnagModalOpen(false); 

                    if (!isDesktop) {
                        setActivePanel('items');
                    }
                }
            };

            const updateSnagInDB = async (id, updates) => {
                if (!supabaseClient) return setStatus('Connection not ready.');

                const { error } = await supabaseClient
                    .from(TABLE_NAME)
                    .update({ 
                        ...updates,
                        updated_at: new Date().toISOString(),
                    })
                    .eq('id', id);

                if (error) {
                    console.error("Error updating item:", error);
                    setStatus(`Failed to update item: ${error.message}`);
                } else {
                    setStatus('Item updated. Syncing...');
                }
            };

            const deleteSnagFromDB = async (id) => {
                if (!supabaseClient) return setStatus('Connection not ready.');

                const { error } = await supabaseClient
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error("Error deleting item:", error);
                    setStatus(`Failed to delete item: ${error.message}`);
                } else {
                    setStatus('Item deleted. Syncing...');
                }
            };

            const handleClearDatabase = () => {
                if (!supabaseClient) {
                    setStatus('Error: Cannot connect. Supabase client is not ready.');
                    return;
                }
                
                setModal({
                    type: 'confirm',
                    message: `Are you sure you want to delete **ALL ${totalSnagsCount}** items from the database? This is permanent and only recommended if you have orphaned entries.`,
                    action: (client) => {
                        clearAllSnagsFromDB(client, totalSnagsCount)
                            .then(() => setStatus(`Successfully cleared ALL ${totalSnagsCount} project items (snags) from the database.`))
                            .catch(e => setStatus(`Database clear failed: ${e.message}`));
                    }
                });
            };


            // --- NAVIGATION AND FILTERING ---

            const handleProjectSelect = (project) => {
                setSelectedProject(project);
                const newGroups = allGroupsMap[project] || [];
                setSelectedGroup(newGroups[0] || '');
                if (!isDesktop) {
                    setActivePanel('groups');
                }
            };

            const handleGroupSelect = (group) => {
                setSelectedGroup(group);
                if (!isDesktop) {
                    setActivePanel('items');
                }
            };

            const navigateBack = (fromPanel) => {
                if (!isDesktop) {
                    if (fromPanel === 'items') {
                        setActivePanel('groups');
                    } else if (fromPanel === 'groups') {
                        setActivePanel('projects');
                    }
                }
            };

            const filteredSnags = useMemo(() => {
                // If there are no projects, and nothing is selected, show ALL snags (orphaned list)
                if (allProjects.length === 0) {
                     return snags.sort((a, b) => {
                        if (a.status === 'open' && b.status === 'closed') return -1;
                        if (a.status === 'closed' && b.status === 'open') return 1;
                        return new Date(b.created_at) - new Date(a.created_at);
                    });
                }


                if (!selectedProject || !selectedGroup) return [];

                let filtered = snags;

                filtered = filtered.filter(snag => (snag.header_category || 'Uncategorized') === selectedProject);
                filtered = filtered.filter(snag => (snag.room_name || 'N/A') === selectedGroup);
                
                return filtered.sort((a, b) => {
                    if (a.status === 'open' && b.status === 'closed') return -1;
                    if (a.status === 'closed' && b.status === 'open') return 1;
                    return new Date(b.created_at) - new Date(a.created_at);
                });

            }, [snags, selectedProject, selectedGroup, allProjects.length]);

            const availableGroups = useMemo(() => {
                return selectedProject ? (allGroupsMap[selectedProject] || []) : [];
            }, [selectedProject, allGroupsMap]);


            const injectLink = (markdownLink, target) => {
                if (target === 'edit') {
                    setEditingSnagText(prev => prev.trim() + ' ' + markdownLink + ' ');
                }
                setLinkModal(null);
            };


            const handleAddItemClick = () => {
                if (allProjects.length === 0) {
                    setStatus('Please add a Project first before adding items.');
                    return;
                }
                
                if (selectedProject) {
                    setNewProjectCategory(selectedProject);
                    
                    if (selectedGroup) {
                        setNewProjectGroup(selectedGroup);
                    } else {
                        const defaultGroup = allGroupsMap[selectedProject]?.[0] || '';
                        setNewProjectGroup(defaultGroup);
                    }
                }
                setIsAddSnagModalOpen(true);
            };

            const addSnag = (snagText, project, group) => {
                if (!snagText.trim() || !project || !group) {
                    setStatus('Error: Missing item text, project, or group.');
                    return;
                }

                const newSnagData = {
                    header_category: project, 
                    room_name: group,         
                    text: snagText.trim(),
                };
                addNewSnagToDB(newSnagData);
            };

            const toggleSnagStatus = (snag) => {
                const newStatus = snag.status === 'closed' ? 'open' : 'closed';
                updateSnagInDB(snag.id, { status: newStatus });
            };

            const handleDeleteRequest = (snag) => {
                setModal({
                    type: 'confirm',
                    message: `Are you sure you want to delete: "${snag.text.split('[')[0].trim()}..."? This action cannot be undone.`,
                    action: () => deleteSnagFromDB(snag.id)
                });
            };
            
            const startEdit = (snag) => {
                setEditingSnagId(snag.id);
                setEditingSnagText(snag.text);
                setEditingProjectCategory(snag.header_category);
                setEditingProjectGroup(snag.room_name);
            }
            
            const saveEdit = (id) => {
                updateSnagInDB(id, { 
                    text: editingSnagText.trim(), 
                    header_category: editingProjectCategory.trim() || selectedProject,
                    room_name: editingProjectGroup.trim() || selectedGroup,
                });
                setEditingSnagId(null);
                setEditingSnagText('');
            }


            // --- MODAL COMPONENTS ---

            const AddSnagModal = ({ isOpen, onClose, onAddSnag, setLinkModal, allGroupsMap, newProjectCategory, setNewProjectCategory, newProjectGroup, setNewProjectGroup }) => {
                const [snagText, setSnagText] = useState(''); 

                if (!isOpen) return null;

                const allProjs = Object.keys(allGroupsMap).sort();
                const availableGroupsForProject = allGroupsMap[newProjectCategory] || [];
                const canSubmit = snagText.trim() && newProjectCategory && newProjectGroup;

                const injectLocalLink = (markdownLink) => {
                    setSnagText(prev => prev.trim() + ' ' + markdownLink + ' ');
                    setLinkModal(null);
                };

                const handleLinkClick = (e) => {
                    e.preventDefault();
                    setLinkModal({ 
                        type: 'link', 
                        target: 'new',
                        injectFn: injectLocalLink 
                    });
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onAddSnag(snagText, newProjectCategory, newProjectGroup);
                    setSnagText(''); 
                };

                const closeHandler = () => {
                    setSnagText(''); 
                    onClose();
                }

                return (
                    <div className="modal" onClick={closeHandler}>
                        <form className="modal-content" onClick={(e) => e.stopPropagation()} onSubmit={handleSubmit}>
                            <div className="flex items-center justify-between mb-4 border-b pb-3 border-slate-100">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center"><Plus className="w-5 h-5 mr-2 text-accent"/> Add New Project Item</h3>
                                <button type="button" onClick={closeHandler} className="p-1 text-slate-500 hover:text-slate-800 rounded-full"><X className="w-5 h-5" /></button>
                            </div>
                            
                            <div className="flex space-x-3 mb-4">
                                <select
                                    value={newProjectCategory}
                                    onChange={(e) => {
                                        setNewProjectCategory(e.target.value);
                                        const newGroups = allGroupsMap[e.target.value] || [];
                                        setNewProjectGroup(newGroups[0] || '');
                                    }}
                                    className="w-1/2 p-3 border border-slate-300 rounded-xl text-base bg-white focus:outline-none focus:ring-2 focus:ring-primary"
                                    required
                                >
                                    <option value="" disabled>Select Project</option>
                                    {allProjs.map(proj => (
                                        <option key={proj} value={proj}>{proj}</option>
                                    ))}
                                </select>
                                <select
                                    value={newProjectGroup}
                                    onChange={(e) => setNewProjectGroup(e.target.value)}
                                    className="w-1/2 p-3 border border-slate-300 rounded-xl text-base bg-white focus:outline-none focus:ring-2 focus:ring-accent"
                                    required
                                    disabled={!newProjectCategory || availableGroupsForProject.length === 0}
                                >
                                    <option value="" disabled>Select Room</option>
                                    {availableGroupsForProject.map(group => (
                                        <option key={group} value={group}>{group}</option>
                                    ))}
                                </select>
                            </div>

                            <label className="block text-sm font-medium text-slate-700 mb-1">Item Details</label>
                            <textarea
                                rows="3"
                                placeholder="Enter item details (supports [link text](url))"
                                value={snagText}
                                onChange={(e) => setSnagText(e.target.value)}
                                className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-6 text-base"
                                required
                            />

                            <div className="flex justify-between items-center">
                                <button
                                    type="button"
                                    onClick={handleLinkClick}
                                    className="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl text-sm flex items-center shadow-sm"
                                    title="Add a clickable link to the snag text"
                                >
                                    <LinkIcon className="w-4 h-4 mr-1" /> Embed Link
                                </button>
                                <button
                                    type="submit"
                                    className="px-6 py-2.5 bg-accent text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition disabled:opacity-50"
                                    disabled={!canSubmit || !supabaseClient}
                                >
                                    Submit Item
                                </button>
                            </div>
                        </form>
                    </div>
                );
            };

            const CustomModal = ({ modal, closeModal }) => {
                if (!modal) return null;

                const handleAction = () => {
                    // Action handler can be sync or async and might need the client (e.g. clearAllSnagsFromDB)
                    // The action must handle setting status/closing the modal itself, or we close it here.
                    modal.action(supabaseClient); 
                    setModal(null); 
                };

                // Confirmation Modal (Delete Snag Item / Delete Structure Item / Clear DB)
                if (modal.type === 'confirm') {
                    return (
                        <div className="modal" onClick={closeModal}>
                            <div className="modal-content transform transition-all" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center space-x-3 mb-4 border-b pb-3 border-slate-100">
                                    <Trash className="w-6 h-6 text-red-500"/>
                                    <h3 className="text-xl font-bold text-slate-800">Confirm Deletion</h3>
                                </div>
                                <p className="text-slate-600 mb-8" dangerouslySetInnerHTML={{__html: modal.message}}></p>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={closeModal}
                                        className="px-6 py-2.5 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 transition shadow-sm"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleAction}
                                        className="px-6 py-2.5 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition shadow-md"
                                    >
                                        Confirm Deletion
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // Status View Modal
                if (modal.type === 'status_view') {
                    return (
                        <div className="modal" onClick={closeModal}>
                            <div className="modal-content !max-w-xl" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center space-x-3 mb-4 border-b pb-3 border-slate-100">
                                    <h3 className="text-xl font-bold text-slate-800">System Status / Error Log</h3>
                                </div>
                                <p className="text-slate-600 whitespace-pre-wrap break-words max-h-96 overflow-y-auto mb-4 p-2 bg-slate-50 rounded-lg border border-slate-200">{modal.message}</p>
                                <div className="flex justify-end">
                                    <button
                                        onClick={closeModal}
                                        className="px-6 py-2.5 bg-primary text-white font-semibold rounded-xl hover:bg-blue-900 transition shadow-md"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }


                // Structure Management Modal (Add/Edit Project/Group)
                if (modal.type === 'structure') {
                    const [inputValue, setInputValue] = useState(modal.currentName || '');
                    const isAdd = modal.actionType === 'add';
                    const structureName = modal.structureType === 'group' ? 'Room' : 'Project';
                    const title = isAdd ? `Add New ${structureName}` : `Rename ${structureName}`;
                    
                    const handleSubmit = (e) => {
                        e.preventDefault();
                        if (inputValue.trim()) {
                            modal.handler(inputValue.trim());
                            setModal(null);
                        } else {
                            setStatus(`Error: ${structureName} name cannot be empty.`);
                        }
                    };

                    return (
                        <div className="modal" onClick={closeModal}>
                            <form className="modal-content" onClick={(e) => e.stopPropagation()} onSubmit={handleSubmit}>
                                <div className="flex items-center space-x-3 mb-4 border-b pb-3 border-slate-100">
                                    <Edit className="w-6 h-6 text-primary"/>
                                    <h3 className="text-xl font-bold text-slate-800">{title}</h3>
                                </div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">{structureName} Name</label>
                                <input
                                    type="text"
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    placeholder={isAdd ? `e.g., ${structureName === 'Project' ? 'Site A' : 'Kitchen'}` : modal.currentName}
                                    className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-6 text-base"
                                    required
                                />
                                <div className="flex justify-end space-x-3">
                                    <button
                                        type="button"
                                        onClick={closeModal}
                                        className="px-6 py-2.5 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 transition shadow-sm"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-6 py-2.5 bg-primary text-white font-semibold rounded-xl hover:bg-blue-700 transition shadow-md"
                                    >
                                        {isAdd ? 'Add' : 'Save'} {structureName}
                                    </button>
                                </div>
                            </form>
                        </div>
                    );
                }
                
                // Link Injection Modal
                if (modal.type === 'link') {
                    const [linkText, setLinkText] = useState('');
                    const [url, setUrl] = useState('');
                    
                    const handleSubmit = (e) => {
                        e.preventDefault();
                        if (linkText.trim() && url.trim()) {
                            const markdownLink = `[${linkText.trim()}](${url.trim()})`;
                            modal.injectFn(markdownLink);
                            setLinkModal(null);
                        } else {
                            setStatus('Error: Both link text and URL are required.');
                        }
                    };

                    return (
                        <div className="modal" onClick={() => setLinkModal(null)}>
                            <form className="modal-content" onClick={(e) => e.stopPropagation()} onSubmit={handleSubmit}>
                                <h3 className="text-xl font-bold text-slate-800 mb-4 border-b pb-3 border-slate-100">Embed Link</h3>
                                <label className="block text-sm font-medium text-slate-700 mb-1">Link Text (What users click)</label>
                                <input
                                    type="text"
                                    value={linkText}
                                    onChange={(e) => setLinkText(e.target.value)}
                                    placeholder="e.g., Click here for spec sheet"
                                    className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-4 text-base"
                                    required
                                />
                                <label className="block text-sm font-medium text-slate-700 mb-1">URL (The actual link)</label>
                                <input
                                    type="url"
                                    value={url}
                                    onChange={(e) => setUrl(e.target.value)}
                                    placeholder="https://example.com/document"
                                    className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-6 text-base"
                                    required
                                />
                                <div className="flex justify-end space-x-3">
                                    <button
                                        type="button"
                                        onClick={() => setLinkModal(null)}
                                        className="px-6 py-2.5 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 transition shadow-sm"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        type="submit"
                                        className="px-6 py-2.5 bg-blue-500 text-white font-semibold rounded-xl hover:bg-blue-600 transition shadow-md"
                                    >
                                        Insert Link
                                    </button>
                                </div>
                            </form>
                        </div>
                    );
                }
                
                return null;
            };

            // --- PANEL COMPONENTS ---

            const SnagItem = ({ snag, startEdit, toggleSnagStatus, handleDeleteRequest, editingSnagId, editingSnagText, setEditingSnagText, saveEdit, allGroupsMap, editingProjectCategory, setEditingProjectCategory, editingProjectGroup, setEditingProjectGroup, setLinkModal, injectLink, selectedProject, selectedGroup }) => {
                const isEditing = snag.id === editingSnagId;
                const isClosed = snag.status === 'closed';
                
                const allProjs = Object.keys(allGroupsMap).sort();
                const availableGroupsForProject = allGroupsMap[editingProjectCategory] || [];
                
                const handleLinkClick = (e) => {
                    e.preventDefault();
                    setLinkModal({ 
                        type: 'link', 
                        target: 'edit',
                        injectFn: (markdownLink) => injectLink(markdownLink, 'edit')
                    });
                };

                return (
                    <div className={`snag-card p-4 rounded-xl mb-3 border ${isClosed ? 'bg-green-50 border-green-200' : 'bg-white border-slate-200'} transition duration-150 ease-in-out`}>
                        <div className="flex items-start justify-between">
                            
                            <div className="flex-grow">
                                {isEditing ? (
                                    <>
                                        <div className="flex space-x-2 mb-2">
                                            <select
                                                value={editingProjectCategory}
                                                onChange={(e) => setEditingProjectCategory(e.target.value)}
                                                className="p-1 border border-slate-300 rounded-lg text-sm bg-white"
                                            >
                                                {allProjs.map(proj => (
                                                    <option key={proj} value={proj}>{proj}</option>
                                                ))}
                                            </select>
                                            <select
                                                value={editingProjectGroup}
                                                onChange={(e) => setEditingProjectGroup(e.target.value)}
                                                className="p-1 border border-slate-300 rounded-lg text-sm bg-white"
                                            >
                                                {availableGroupsForProject.map(group => (
                                                    <option key={group} value={group}>{group}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <textarea
                                            value={editingSnagText}
                                            onChange={(e) => setEditingSnagText(e.target.value)}
                                            className="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-1 focus:ring-primary mb-2"
                                            rows="3"
                                        />
                                        <div className="flex justify-between items-center mt-2">
                                            <button
                                                onClick={handleLinkClick}
                                                className="text-xs text-blue-500 hover:text-blue-700 font-medium flex items-center p-1 rounded-lg"
                                            >
                                                <LinkIcon className="w-3 h-3 mr-1"/> Embed Link
                                            </button>
                                            <div className="space-x-2">
                                                <button onClick={() => setEditingSnagId(null)} className="px-3 py-1 text-sm text-slate-600 bg-slate-100 rounded-xl hover:bg-slate-200">
                                                    Cancel
                                                </button>
                                                <button onClick={() => saveEdit(snag.id)} className="px-3 py-1 text-sm text-white bg-accent rounded-xl hover:bg-green-600">
                                                    Save
                                                </button>
                                            </div>
                                        </div>
                                    </>
                                ) : (
                                    <>
                                        <p className={`snag-description text-sm mb-2 text-slate-800 leading-relaxed ${isClosed ? 'line-through text-slate-500' : ''}`} 
                                           dangerouslySetInnerHTML={renderMarkdownLinks(snag.text)}></p>
                                        
                                        <div className="flex flex-wrap items-center space-x-2 text-xs text-slate-500 mt-1">
                                            <span className="px-2 py-0.5 bg-slate-100 rounded-full font-medium shadow-inner">{snag.room_name}</span>
                                            <span className="px-2 py-0.5 bg-slate-100 rounded-full font-medium shadow-inner">{snag.header_category}</span>
                                            <span className="ml-auto text-xs italic opacity-70">
                                                {snag.updated_at ? `Updated: ${new Date(snag.updated_at).toLocaleDateString()}` : `Created: ${new Date(snag.created_at).toLocaleDateString()}`}
                                            </span>
                                        </div>
                                    </>
                                )}
                            </div>

                            {!isEditing && (
                                <div className="flex flex-col ml-3 space-y-2">
                                    <button 
                                        onClick={() => toggleSnagStatus(snag)} 
                                        className={`p-2 rounded-full shadow-md transition ${isClosed ? 'bg-status-closed text-white hover:bg-green-600' : 'bg-status-open text-white hover:bg-amber-600'}`}
                                        title={isClosed ? 'Mark as Open' : 'Mark as Closed'}
                                    >
                                        {isClosed ? <Check className="w-4 h-4"/> : <X className="w-4 h-4"/>}
                                    </button>
                                    <button 
                                        onClick={() => startEdit(snag)} 
                                        className="p-2 bg-slate-200 text-slate-700 rounded-full hover:bg-slate-300 transition shadow-md"
                                        title="Edit Item"
                                    >
                                        <Edit className="w-4 h-4"/>
                                    </button>
                                    <button 
                                        onClick={() => handleDeleteRequest(snag)} 
                                        className="p-2 bg-red-100 text-red-500 rounded-full hover:bg-red-200 transition shadow-md"
                                        title="Delete Item"
                                    >
                                        <Trash className="w-4 h-4"/>
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const ProjectsPanel = ({ allProjects, selectedProject, onSelectProject, structureAction, isDesktop, activePanel, isClearDbVisible, handleClearDatabase, totalSnagsCount }) => {
                const isActive = isDesktop || activePanel === 'projects';

                // Removed lg:w-1/4
                return (
                    <div className={`panel projects-panel ${isActive ? 'active-panel' : 'hidden-right'}`}>
                        <div className="p-4 border-b border-slate-200 bg-white">
                            <h2 className="text-xl font-bold text-primary flex items-center">
                                <LayoutGrid className="w-5 h-5 mr-2"/> Projects ({allProjects.length})
                            </h2>
                            <p className="text-xs text-slate-500 mt-1">Select a Project to view Rooms.</p>
                        </div>
                        
                        <div className="panel-list-wrapper">
                            {allProjects.length === 0 ? (
                                <div className="p-4 text-center text-slate-500 pt-16">
                                    <p className="mb-4">No projects defined yet.</p>
                                    <button
                                        onClick={() => structureAction('project', 'add')}
                                        className="px-4 py-2 bg-primary text-white font-semibold rounded-xl hover:bg-blue-700 transition shadow-md text-sm"
                                    >
                                        <Plus className="w-4 h-4 inline-block mr-1"/> Add New Project
                                    </button>
                                </div>
                            ) : (
                                allProjects.map(project => (
                                    <div 
                                        key={project}
                                        onClick={() => onSelectProject(project)}
                                        className={`flex items-center justify-between p-3 cursor-pointer border-b hover:bg-slate-50 transition ${selectedProject === project ? 'bg-blue-50 border-blue-200 font-semibold' : 'bg-white border-slate-100'}`}
                                    >
                                        <span className={`truncate ${selectedProject === project ? 'text-primary' : 'text-slate-800'}`}>
                                            {project}
                                        </span>
                                        <div className="flex space-x-1 ml-2">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); structureAction('project', 'edit', project); }}
                                                className="p-1 text-slate-400 hover:text-blue-500 rounded-md"
                                                title="Rename Project"
                                            >
                                                <Edit className="w-4 h-4"/>
                                            </button>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); structureAction('project', 'delete', project); }}
                                                className="p-1 text-slate-400 hover:text-red-500 rounded-md"
                                                title="Delete Project"
                                            >
                                                <Trash className="w-4 h-4"/>
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* Panel Footer for Add Project */}
                        <div className={`p-4 border-t ${isClearDbVisible ? 'border-red-100' : 'border-slate-200'} bg-white`}>
                            {allProjects.length > 0 && (
                                <button
                                    onClick={() => structureAction('project', 'add')}
                                    className="w-full px-4 py-2 bg-primary text-white font-semibold rounded-xl hover:bg-blue-700 transition shadow-md text-sm mb-3"
                                >
                                    <Plus className="w-4 h-4 inline-block mr-1"/> Add New Project
                                </button>
                            )}

                            {/* Conditional Clear Database Button (NEW REQUIREMENT) */}
                            {isClearDbVisible && (
                                <button
                                    onClick={handleClearDatabase}
                                    className="w-full px-4 py-2 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition shadow-md flex items-center justify-center text-sm disabled:opacity-50"
                                    title="Warning: This clears ALL snag items from the database permanently."
                                    disabled={!supabaseClient} // Ensure connection is ready before showing/allowing click
                                >
                                    <Trash className="w-4 h-4 mr-1"/> Clear Orphaned Entries ({totalSnagsCount})
                                </button>
                            )}
                        </div>
                    </div>
                );
            };

            const GroupsPanel = ({ allGroupsMap, selectedProject, selectedGroup, onSelectGroup, structureAction, isDesktop, activePanel, navigateBack }) => {
                const isActive = isDesktop || activePanel === 'groups';
                const availableGroups = allGroupsMap[selectedProject] || [];

                // Removed lg:w-1/4
                return (
                    <div className={`panel groups-panel ${isActive ? 'active-panel' : 'hidden-right'}`}>
                        
                        {/* Header */}
                        <div className="p-4 border-b border-slate-200 bg-white">
                            <div className="flex items-center">
                                {!isDesktop && (
                                    <button onClick={() => navigateBack('groups')} className="mr-2 p-1 text-slate-500 hover:text-slate-800 rounded-full">
                                        <ArrowLeft className="w-5 h-5"/>
                                    </button>
                                )}
                                <h3 className="text-lg font-bold text-slate-800 truncate">
                                    {selectedProject || 'Select Project'}
                                </h3>
                            </div>
                            <p className="text-xs text-slate-500 mt-1">Select a Room/Area to view items.</p>
                        </div>

                        {/* List */}
                        <div className="panel-list-wrapper">
                            {selectedProject && availableGroups.length === 0 ? (
                                <div className="p-4 text-center text-slate-500 pt-16">
                                    <p className="mb-4">No rooms defined for this project.</p>
                                    <button
                                        onClick={() => structureAction('group', 'add', '', selectedProject)}
                                        className="px-4 py-2 bg-accent text-white font-semibold rounded-xl hover:bg-green-600 transition shadow-md text-sm"
                                    >
                                        <Plus className="w-4 h-4 inline-block mr-1"/> Add New Room
                                    </button>
                                </div>
                            ) : (
                                selectedProject && availableGroups.map(group => (
                                    <div 
                                        key={group}
                                        onClick={() => onSelectGroup(group)}
                                        className={`flex items-center justify-between p-3 cursor-pointer border-b hover:bg-slate-50 transition ${selectedGroup === group ? 'bg-green-50 border-green-200 font-semibold' : 'bg-white border-slate-100'}`}
                                    >
                                        <span className={`truncate ${selectedGroup === group ? 'text-accent' : 'text-slate-800'}`}>
                                            {group}
                                        </span>
                                        <div className="flex space-x-1 ml-2">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); structureAction('group', 'edit', group, selectedProject); }}
                                                className="p-1 text-slate-400 hover:text-blue-500 rounded-md"
                                                title="Rename Room"
                                            >
                                                <Edit className="w-4 h-4"/>
                                            </button>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); structureAction('group', 'delete', group, selectedProject); }}
                                                className="p-1 text-slate-400 hover:text-red-500 rounded-md"
                                                title="Delete Room"
                                            >
                                                <Trash className="w-4 h-4"/>
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* Panel Footer for Add Group */}
                        {selectedProject && (
                            <div className="p-4 border-t border-slate-200 bg-white">
                                <button
                                    onClick={() => structureAction('group', 'add', '', selectedProject)}
                                    className="w-full px-4 py-2 bg-accent text-white font-semibold rounded-xl hover:bg-green-600 transition shadow-md text-sm"
                                    disabled={!selectedProject}
                                >
                                    <Plus className="w-4 h-4 inline-block mr-1"/> Add Room to {selectedProject}
                                </button>
                            </div>
                        )}
                    </div>
                );
            };

            const ItemsPanel = ({ filteredSnags, selectedProject, selectedGroup, isDesktop, activePanel, navigateBack, ...snagProps }) => {
                const isActive = isDesktop || activePanel === 'items';

                const displayTitle = allProjects.length === 0 ? 'Orphaned Items (No Projects)' : `${selectedProject} - ${selectedGroup}`;

                // Removed lg:w-1/2
                return (
                    <div className={`panel items-panel ${isActive ? 'active-panel' : 'hidden-right'}`}>
                        {/* Header */}
                        <div className="p-4 border-b border-slate-200 bg-white shadow-sm">
                            <div className="flex items-center">
                                {!isDesktop && (
                                    <button onClick={() => navigateBack('items')} className="mr-2 p-1 text-slate-500 hover:text-slate-800 rounded-full">
                                        <ArrowLeft className="w-5 h-5"/>
                                    </button>
                                )}
                                <h3 className="text-xl font-bold text-slate-800 truncate">
                                    {displayTitle} ({filteredSnags.length})
                                </h3>
                            </div>
                            <p className="text-xs text-slate-500 mt-1">Found {filteredSnags.filter(s => s.status === 'open').length} open items. {filteredSnags.filter(s => s.status === 'closed').length} closed.</p>
                        </div>
                        
                        {/* List */}
                        <div className="panel-list-wrapper p-4 bg-gray-50">
                            {filteredSnags.length === 0 && (allProjects.length === 0 || (selectedProject && selectedGroup)) ? (
                                <div className="text-center text-slate-500 pt-16">
                                    <p className="mb-4">No items found for this selection.</p>
                                </div>
                            ) : filteredSnags.length === 0 && (!selectedProject || !selectedGroup) ? (
                                <div className="text-center text-slate-500 pt-16">
                                    <p className="mb-4">Please select a Project and Room to view items.</p>
                                </div>
                            ) : (
                                filteredSnags.map(snag => (
                                    <SnagItem key={snag.id} snag={snag} {...snagProps} />
                                ))
                            )}
                        </div>

                        {/* Panel Footer for Add Item */}
                        <div className="p-4 border-t border-slate-200 bg-white">
                            <button
                                onClick={handleAddItemClick}
                                className="w-full px-4 py-2 bg-blue-500 text-white font-bold rounded-xl hover:bg-blue-600 transition shadow-lg flex items-center justify-center disabled:opacity-50"
                                disabled={!selectedProject || !selectedGroup || !supabaseClient}
                                title={!selectedProject ? 'Select a Project and Room first' : 'Add new item'}
                            >
                                <Plus className="w-5 h-5 mr-1"/> Add Item to {selectedGroup || 'Room'}
                            </button>
                        </div>
                    </div>
                );
            };

            // --- MAIN RENDER ---
            return (
                <div className="app-container">
                    {/* Header Bar */}
                    <header className="flex items-center justify-between p-4 bg-white shadow-md border-b border-slate-200">
                        <h1 className="text-2xl font-extrabold text-slate-800">
                            Snag <span className="text-primary">Tracker</span>
                        </h1>
                        <div className="flex items-center space-x-3">
                            <span 
                                onClick={() => setModal({ type: 'status_view', message: status })}
                                className="text-sm cursor-pointer px-3 py-1 bg-slate-100 rounded-full font-medium text-slate-600 hover:bg-slate-200 transition"
                                title="Click to view full status log"
                            >
                                Status: {status.split(':')[0]}
                            </span>
                        </div>
                    </header>
                    
                    {/* Main Content Panels */}
                    <div className="main-content">
                        
                        <ProjectsPanel 
                            allProjects={allProjects}
                            selectedProject={selectedProject}
                            onSelectProject={handleProjectSelect}
                            structureAction={structureAction}
                            isDesktop={isDesktop}
                            activePanel={activePanel}
                            isClearDbVisible={isClearDbVisible}
                            handleClearDatabase={handleClearDatabase}
                            totalSnagsCount={totalSnagsCount}
                        />

                        <GroupsPanel
                            allGroupsMap={allGroupsMap}
                            selectedProject={selectedProject}
                            selectedGroup={selectedGroup}
                            onSelectGroup={handleGroupSelect}
                            structureAction={structureAction}
                            isDesktop={isDesktop}
                            activePanel={activePanel}
                            navigateBack={navigateBack}
                        />

                        <ItemsPanel 
                            filteredSnags={filteredSnags}
                            selectedProject={selectedProject}
                            selectedGroup={selectedGroup}
                            isDesktop={isDesktop}
                            activePanel={activePanel}
                            navigateBack={navigateBack}
                            startEdit={startEdit}
                            toggleSnagStatus={toggleSnagStatus}
                            handleDeleteRequest={handleDeleteRequest}
                            editingSnagId={editingSnagId}
                            editingSnagText={editingSnagText}
                            setEditingSnagText={setEditingSnagText}
                            saveEdit={saveEdit}
                            allGroupsMap={allGroupsMap}
                            editingProjectCategory={editingProjectCategory}
                            setEditingProjectCategory={setEditingProjectCategory}
                            editingProjectGroup={editingProjectGroup}
                            setEditingProjectGroup={setEditingProjectGroup}
                            setLinkModal={setLinkModal}
                            injectLink={injectLink}
                        />
                        
                    </div>

                    {/* Modals */}
                    <AddSnagModal 
                        isOpen={isAddSnagModalOpen}
                        onClose={() => setIsAddSnagModalOpen(false)}
                        onAddSnag={addSnag}
                        setLinkModal={setLinkModal}
                        allGroupsMap={allGroupsMap}
                        newProjectCategory={newProjectCategory}
                        setNewProjectCategory={setNewProjectCategory}
                        newProjectGroup={newProjectGroup}
                        setNewProjectGroup={setNewProjectGroup}
                    />
                    <CustomModal modal={modal} closeModal={() => setModal(null)} />
                    <CustomModal modal={linkModal} closeModal={() => setLinkModal(null)} />
                    
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Tracker />);
    </script>
</body>
</html>
