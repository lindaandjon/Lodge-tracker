<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lodge Build Tracker</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    
    <!-- Firebase Libraries (using type="module" to import functions) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, setDoc, deleteDoc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase dependencies and environment variables globally for the Babel/React script
        window.firebaseDependencies = {
            initializeApp, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged,
            getFirestore, collection, query, onSnapshot, doc, setDoc, deleteDoc, updateDoc, addDoc
        };
        
        // Pass global Canvas environment variables
        window.envVars = {
            appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id',
            firebaseConfig: typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null,
            authToken: typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null,
        };
    </script>

    <style>
        .snag-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Style for required modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-slate-50 font-sans antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // --- CONFIGURATION ---
        const APP_VERSION = '3.0'; 
        const COLLECTION_NAME = 'snags';

        // Initial state for snags (only used if Firestore is empty)
        const initialSnags = [
            { id: 1, text: "Example Snag: Check plumbing under master sink.", status: 'open', photo: null, link: null },
        ];

        // Utility: Generate a simple icon/component
        const X = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>;
        const Check = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6L9 17l-5-5"/></svg>;
        const Trash = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>;
        const Edit = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const Plus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>;
        const LinkIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>;
        const Camera = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>;
        const Upload = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>;
        const AlertIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>;


        function LodgeTracker() {
            const [snags, setSnags] = useState([]);
            const [newSnagText, setNewSnagText] = useState('');
            const [status, setStatus] = useState('Initializing Firebase...');
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [viewingPhoto, setViewingPhoto] = useState(null);
            const [editingSnagId, setEditingSnagId] = useState(null);
            const [editingSnagText, setEditingSnagText] = useState('');
            const [modal, setModal] = useState(null); // { type: 'confirm', message: '', action: () => {} }
            
            // Firebase instances
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);

            // --- FIREBASE INITIALIZATION & DATA LISTENER ---

            useEffect(() => {
                const initFirebase = async () => {
                    const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, getFirestore, onAuthStateChanged } = window.firebaseDependencies;
                    const { firebaseConfig, authToken } = window.envVars;

                    if (!firebaseConfig) {
                        setStatus('Error: Firebase configuration missing.');
                        return;
                    }
                    
                    try {
                        const app = initializeApp(firebaseConfig);
                        const authInstance = getAuth(app);
                        const dbInstance = getFirestore(app);
                        
                        setAuth(authInstance);
                        setDb(dbInstance);

                        // 1. Authenticate the user
                        if (authToken) {
                            await signInWithCustomToken(authInstance, authToken);
                            setStatus('Authenticated via custom token.');
                        } else {
                            await signInAnonymously(authInstance);
                            setStatus('Authenticated anonymously.');
                        }

                        // 2. Set up Auth State Listener
                        onAuthStateChanged(authInstance, (user) => {
                            if (user) {
                                setUserId(user.uid);
                            } else {
                                setUserId(null);
                            }
                            setIsAuthReady(true);
                        });

                    } catch (error) {
                        console.error("Firebase Initialization Error:", error);
                        setStatus(`Firebase Error: ${error.message}. Check console.`);
                    }
                };

                initFirebase();
            }, []); // Run only once on mount

            // 3. Set up Real-time Firestore Listener
            useEffect(() => {
                if (!db || !isAuthReady || !userId) return;

                setStatus(`Loading data for user ${userId.substring(0, 8)}...`);
                
                // Firestore path: /artifacts/{appId}/users/{userId}/snags
                const { collection, query, onSnapshot } = window.firebaseDependencies;
                const { appId } = window.envVars;

                const path = `artifacts/${appId}/users/${userId}/${COLLECTION_NAME}`;
                const q = query(collection(db, path));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const loadedSnags = snapshot.docs.map(doc => ({
                        // The Firestore ID is the document ID
                        firestoreId: doc.id,
                        // Parse other data
                        ...doc.data()
                    }));
                    
                    if (loadedSnags.length === 0) {
                         // If no data exists, populate with initial snags
                        if (initialSnags.length > 0) {
                            initialSnags.forEach(async (snag) => {
                                // Add initial snags to the database
                                const newDocRef = collection(db, path);
                                await addDoc(newDocRef, {
                                    ...snag,
                                    createdAt: new Date().toISOString(),
                                });
                            });
                            // Set initial state locally temporarily until onSnapshot fires again
                            setSnags(initialSnags.map(s => ({...s, firestoreId: s.id})));
                            setStatus('Initialized new tracker for user.');
                        } else {
                            setSnags([]);
                            setStatus('Tracker synced. Ready to add snags.');
                        }
                    } else {
                        // Sort loaded snags by their original ID or creation time for stability
                        loadedSnags.sort((a, b) => (a.createdAt || 0) > (b.createdAt || 0) ? 1 : -1);
                        setSnags(loadedSnags);
                        setStatus(`Tracker synced. ${loadedSnags.length} items loaded.`);
                    }
                }, (error) => {
                    console.error("Firestore Snapshot Error:", error);
                    setStatus(`Database Error: ${error.message}`);
                });

                // Clean up the listener on component unmount or dependency change
                return () => unsubscribe();
            }, [db, isAuthReady, userId]);

            
            // --- FIREBASE CRUD OPERATIONS ---

            const getSnagPath = useMemo(() => {
                if (!userId || !window.envVars.appId) return null;
                const { appId } = window.envVars;
                return `artifacts/${appId}/users/${userId}/${COLLECTION_NAME}`;
            }, [userId]);

            const addNewSnagToDB = async (snagData) => {
                if (!db || !getSnagPath) return;
                try {
                    const { collection, addDoc } = window.firebaseDependencies;
                    await addDoc(collection(db, getSnagPath), {
                        ...snagData,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                    });
                } catch (error) {
                    console.error("Error adding snag:", error);
                    setStatus(`Failed to add snag: ${error.message}`);
                }
            };

            const updateSnagInDB = async (firestoreId, updates) => {
                if (!db || !getSnagPath) return;
                try {
                    const { doc, updateDoc } = window.firebaseDependencies;
                    const docRef = doc(db, getSnagPath, firestoreId);
                    await updateDoc(docRef, {
                        ...updates,
                        updatedAt: new Date().toISOString(),
                    });
                } catch (error) {
                    console.error("Error updating snag:", error);
                    setStatus(`Failed to update snag: ${error.message}`);
                }
            };

            const deleteSnagFromDB = async (firestoreId) => {
                if (!db || !getSnagPath) return;
                try {
                    const { doc, deleteDoc } = window.firebaseDependencies;
                    const docRef = doc(db, getSnagPath, firestoreId);
                    await deleteDoc(docRef);
                } catch (error) {
                    console.error("Error deleting snag:", error);
                    setStatus(`Failed to delete snag: ${error.message}`);
                }
            };


            // --- UI/STATE HANDLERS ---

            const addSnag = (e) => {
                e.preventDefault();
                if (!newSnagText.trim() || !userId) return;

                const newSnagData = {
                    text: newSnagText.trim(),
                    status: 'open',
                    photo: null,
                    link: null
                };
                addNewSnagToDB(newSnagData);
                setNewSnagText('');
            };

            const toggleSnagStatus = (snag) => {
                const newStatus = snag.status === 'open' ? 'closed' : 'open';
                updateSnagInDB(snag.firestoreId, { status: newStatus });
            };

            const handleDeleteRequest = (snag) => {
                setModal({
                    type: 'confirm',
                    message: `Are you sure you want to delete the snag: "${snag.text}"?`,
                    action: () => deleteSnagFromDB(snag.firestoreId)
                });
            };
            
            const startEdit = (snag) => {
                setEditingSnagId(snag.firestoreId);
                setEditingSnagText(snag.text);
            }
            
            const saveEdit = (firestoreId) => {
                updateSnagInDB(firestoreId, { text: editingSnagText.trim() });
                setEditingSnagId(null);
                setEditingSnagText('');
            }

            const handlePhotoUpload = (event, snag) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    // Update photo property in Firestore
                    updateSnagInDB(snag.firestoreId, { photo: e.target.result });
                };
                reader.readAsDataURL(file);
            };
            
            const handleLinkUpdate = (snag, link) => {
                 updateSnagInDB(snag.firestoreId, { link: link.trim() });
            };

            const CustomModal = ({ modal, closeModal }) => {
                if (!modal) return null;

                const handleAction = () => {
                    modal.action();
                    closeModal();
                };

                return (
                    <div className="modal">
                        <div className="modal-content">
                            <div className="flex items-center space-x-3 mb-4 border-b pb-2">
                                <AlertIcon className="w-6 h-6 text-red-500"/>
                                <h3 className="text-xl font-bold">Confirmation</h3>
                            </div>
                            <p className="text-slate-700 mb-6">{modal.message}</p>
                            <div className="flex justify-end space-x-3">
                                <button
                                    onClick={closeModal}
                                    className="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleAction}
                                    className="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
                                >
                                    Confirm Delete
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };


            const SnagItem = ({ snag }) => {
                const isEditing = editingSnagId === snag.firestoreId;

                const statusClasses = snag.status === 'closed'
                    ? 'bg-green-100 border-green-400 text-green-800 line-through'
                    : 'bg-white border-yellow-400 text-slate-800';
                
                return (
                    <div className={`snag-card p-4 rounded-xl border-l-8 transition duration-300 ${statusClasses} mb-3 flex flex-col sm:flex-row items-start sm:items-center justify-between`}>
                        <div className="flex-grow w-full sm:w-auto">
                            {isEditing ? (
                                <input
                                    type="text"
                                    value={editingSnagText}
                                    onChange={(e) => setEditingSnagText(e.target.value)}
                                    className="w-full text-lg font-medium p-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                />
                            ) : (
                                <p className="text-lg font-medium break-words pr-4">{snag.text}</p>
                            )}

                            <div className="flex flex-wrap items-center mt-2 space-x-2">
                                {snag.photo && (
                                    <button 
                                        onClick={() => setViewingPhoto({ data: snag.photo, text: snag.text })}
                                        className="text-blue-600 hover:text-blue-800 text-sm flex items-center p-1 rounded-full bg-blue-50 hover:bg-blue-100 transition"
                                    >
                                        <Camera className="w-4 h-4 mr-1" /> View Photo
                                    </button>
                                )}
                                {snag.link && (
                                    <a 
                                        href={snag.link} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        className="text-indigo-600 hover:text-indigo-800 text-sm flex items-center p-1 rounded-full bg-indigo-50 hover:bg-indigo-100 transition"
                                    >
                                        <LinkIcon className="w-4 h-4 mr-1" /> View Link
                                    </a>
                                )}
                                {!isEditing && (
                                    <label htmlFor={`photo-upload-${snag.firestoreId}`} className="cursor-pointer text-slate-600 hover:text-slate-800 text-sm flex items-center p-1 rounded-full bg-slate-100 hover:bg-slate-200 transition">
                                        <Upload className="w-4 h-4 mr-1" /> Add Photo
                                        <input 
                                            id={`photo-upload-${snag.firestoreId}`} 
                                            type="file" 
                                            accept="image/*" 
                                            className="hidden" 
                                            onChange={(e) => handlePhotoUpload(e, snag)}
                                        />
                                    </label>
                                )}
                                {isEditing && (
                                    <input
                                        type="url"
                                        placeholder="Add Link URL"
                                        defaultValue={snag.link || ''}
                                        onBlur={(e) => handleLinkUpdate(snag, e.target.value)}
                                        className="text-sm p-1 border border-slate-300 rounded-lg w-32"
                                    />
                                )}
                            </div>
                        </div>
                        
                        <div className="flex items-center space-x-2 mt-3 sm:mt-0">
                            {isEditing ? (
                                <button 
                                    onClick={() => saveEdit(snag.firestoreId)}
                                    className="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full transition shadow-md"
                                    title="Save Edit"
                                >
                                    <Check className="w-5 h-5" />
                                </button>
                            ) : (
                                <button 
                                    onClick={() => startEdit(snag)}
                                    className="p-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-full transition shadow-md"
                                    title="Edit Snag"
                                >
                                    <Edit className="w-5 h-5" />
                                </button>
                            )}
                            
                            <button 
                                onClick={() => toggleSnagStatus(snag)}
                                className={`p-2 rounded-full transition shadow-md ${snag.status === 'open' ? 'bg-green-500 hover:bg-green-600 text-white' : 'bg-slate-300 hover:bg-slate-400 text-slate-700'}`}
                                title={snag.status === 'open' ? 'Mark Complete' : 'Mark Open'}
                            >
                                <Check className="w-5 h-5" />
                            </button>
                            <button 
                                onClick={() => handleDeleteRequest(snag)}
                                className="p-2 bg-red-500 hover:bg-red-600 text-white rounded-full transition shadow-md"
                                title="Delete Snag"
                            >
                                <Trash className="w-5 h-5" />
                            </button>
                        </div>
                    </div>
                );
            };

            const openSnags = snags.filter(snag => snag.status === 'open');
            const closedSnags = snags.filter(snag => snag.status === 'closed');
            const connectionStatus = userId ? `Connected | User ID: ${userId.substring(0, 8)}...` : 'Not connected';
            
            return (
                <div className="min-h-screen bg-slate-50 p-4 sm:p-8">
                    {/* Confirmation Modal */}
                    <CustomModal modal={modal} closeModal={() => setModal(null)} />

                    <header className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 pb-4 border-b border-slate-200">
                        <h1 className="text-3xl font-bold text-slate-800">Lodge Build Tracker</h1>
                        <div className="flex items-center space-x-3 mt-3 sm:mt-0">
                            <span className={`text-sm font-medium p-2 rounded-full ${userId ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'}`}>
                                ☁️ {connectionStatus}
                            </span>
                        </div>
                    </header>
                    
                    <p className="mb-4 text-sm text-center text-slate-600 p-3 bg-slate-100 rounded-lg">
                        **Status:** {status}
                    </p>

                    <main className="max-w-4xl mx-auto">
                        
                        {/* Add New Snag Form */}
                        <form onSubmit={addSnag} className="mb-8 p-6 bg-white rounded-xl shadow-lg">
                            <h2 className="text-xl font-semibold text-slate-700 mb-4 flex items-center"><Plus className="w-5 h-5 mr-2"/> Add New Snag</h2>
                            <div className="flex flex-col sm:flex-row gap-3">
                                <input
                                    type="text"
                                    placeholder="Enter a new snag item (e.g., 'Touch up paint in bedroom 2')"
                                    value={newSnagText}
                                    onChange={(e) => setNewSnagText(e.target.value)}
                                    className="flex-grow p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    required
                                    disabled={!isAuthReady}
                                />
                                <button 
                                    type="submit"
                                    className="px-6 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition shadow-md"
                                    disabled={!isAuthReady || !newSnagText.trim()}
                                >
                                    Add Snag
                                </button>
                            </div>
                        </form>

                        {/* Snag Lists */}
                        <div className="grid md:grid-cols-2 gap-6">
                            {/* Open Snags */}
                            <div>
                                <h2 className="text-2xl font-bold text-yellow-600 mb-4 p-2 rounded-lg bg-yellow-50">🚧 Open Snags ({openSnags.length})</h2>
                                {!isAuthReady && <p className="text-slate-500 p-4 bg-white rounded-xl shadow">Awaiting secure connection...</p>}
                                {isAuthReady && openSnags.length === 0 && (
                                    <p className="text-slate-500 p-4 bg-white rounded-xl shadow">All clear! No open snags.</p>
                                )}
                                {isAuthReady && openSnags.map(snag => <SnagItem key={snag.firestoreId} snag={snag} />)}
                            </div>

                            {/* Closed Snags */}
                            <div>
                                <h2 className="text-2xl font-bold text-green-600 mb-4 p-2 rounded-lg bg-green-50">✅ Closed Snags ({closedSnags.length})</h2>
                                {!isAuthReady && <p className="text-slate-500 p-4 bg-white rounded-xl shadow">Awaiting secure connection...</p>}
                                {isAuthReady && closedSnags.length === 0 && (
                                    <p className="text-slate-500 p-4 bg-white rounded-xl shadow">No completed snags yet.</p>
                                )}
                                {isAuthReady && closedSnags.map(snag => <SnagItem key={snag.firestoreId} snag={snag} />)}
                            </div>
                        </div>
                    </main>

                    {/* Photo Viewer Modal */}
                    {viewingPhoto && (
                        <div className="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" onClick={() => setViewingPhoto(null)}>
                            <div className="relative max-w-4xl max-h-full">
                                <button onClick={(e) => { e.stopPropagation(); setViewingPhoto(null); }} className="absolute -top-10 right-0 p-3 bg-white text-slate-800 rounded-full hover:bg-slate-100 transition shadow-lg">
                                    <X size={24} />
                                </button>
                                <img 
                                    src={viewingPhoto.data} 
                                    alt={viewingPhoto.text} 
                                    className="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl" 
                                    onClick={(e) => e.stopPropagation()} // Prevent closing when clicking the image
                                />
                                <p className="text-white text-center mt-2 font-medium">{viewingPhoto.text}</p>
                            </div>
                        </div>
                    )}
                    
                    <footer className="mt-12 text-center text-sm text-slate-500 border-t pt-4 max-w-4xl mx-auto">
                        Lodge Tracker v{APP_VERSION} | Data saved securely with Firestore
                    </footer>
                </div>
            );
        }

        // Standard React initialization
        ReactDOM.render(<LodgeTracker />, document.getElementById('root'));
    </script>
</body>
</html>
