<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Snag Tracker</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%231E40AF' d='M2 19h20v2H2zM20 7H4v10h16V7zM12 4l-2 3h4l-2-3z'/%3E%3C/svg%3E">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#1E40AF', // Blue-800
                        'accent': '#10B981',  // Green-500
                        'status-open': '#F59E0B', // Amber-500
                        'status-closed': '#10B981', // Green-500
                    }
                }
            }
        }
    </script>
    <!-- React & Babel -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Custom styles for the sleek look */
        html, body, #root {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column; 
        }

        /* Base Mobile (Single Column) */
        .main-content { 
            flex-grow: 1;
            display: grid;
            grid-template-columns: 1fr; 
            overflow: hidden;
            position: relative; /* Needed for absolute positioning of mobile panels */
        }
        
        .panel {
            padding: 0;
            background-color: white;
            display: flex;
            flex-direction: column;
            overflow-y: hidden; 
            /* Mobile: Absolute position for smooth transitions */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease-in-out, z-index 0s;
            z-index: 10;
        }

        /* Panel transitions for mobile sliding effect */
        .panel.hidden-right { transform: translateX(100%); z-index: 5; }
        .panel.active-panel { transform: translateX(0); z-index: 15; }

        /* Desktop (lg breakpoint) 3-Column Layout */
        @media (min-width: 1024px) {
            .main-content {
                /* Define 3 distinct columns */
                grid-template-columns: minmax(180px, 1fr) minmax(250px, 1.5fr) minmax(350px, 3fr);
            }
            .panel {
                position: relative; /* Revert to normal flow on desktop */
                z-index: 1;
                /* Remove mobile transform */
                transform: none !important;
                /* Add border separation */
                border-right: 1px solid #E2E8F0; /* slate-200 */
            }
            /* The items panel is the last one, no right border needed */
            .items-panel {
                 border-right: none;
            }
        }

        .panel-list-wrapper { /* General purpose wrapper for scrollable lists */
            flex-grow: 1;
            overflow-y: auto;
        }

        .snag-card {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.08), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
            cursor: default;
        }
        
        /* FIX FOR MOBILE KEYBOARD OVERLAP: Align items to the top and use padding-top/bottom */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(15, 23, 42, 0.8);
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Aligns content to the top */
            z-index: 1000;
            overflow-y: auto; 
            padding-top: 5vh; /* Push content down from the top */
            padding-bottom: 5vh; 
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 450px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            margin-top: 0; /* Ensures content starts from the top padding */
        }
        .snag-description a {
            color: #2563EB; 
            text-decoration: underline;
            font-weight: 600;
            word-break: break-word;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div id="root" class="app-container"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;
        
        // --- CONFIGURATION ---
        const APP_VERSION = '13.1 (Rename Fix & UI Polish)'; 
        const TABLE_NAME = 'snags';
        const CATEGORY_STORAGE_KEY = 'snag_projects_v11_3'; 
        
        // NEW CONFIG for DB structure storage
        const STRUCTURE_TABLE = 'app_structure';
        const STRUCTURE_ROW_ID = 'project_room_map_v1';
        
        // !!! IMPORTANT: Supabase URL has been pasted below. Please replace the ANON KEY placeholder !!!
        const SUPABASE_URL = 'https://ejozspveaasscxqovitn.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVqb3pzcHZlYWFzc2N4cW92aXRuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MzMyOTcsImV4cCI6MjA3NjAwOTI5N30.D--chXcvpMl_gDRY0ZvBcAg3nzwwDAuuFHTB2pgYtZ8';
        // --- END CONFIGURATION ---
        
        // Initial setup data (Used only if DB is empty AND localStorage is empty)
        // Set to empty {} for a blank canvas start.
        const INITIAL_PROJECTS = {};

        // --- ICONS (Lucide React equivalent SVGs) ---
        const X = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>;
        const Check = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6L9 17l-5-5"/></svg>;
        const Trash = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M10 4h4V2h-4z"/></svg>; 
        const Edit = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5L2 22l1.5-5.5L17 3z"/></svg>;
        const Plus = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>;
        const Camera = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>;
        const LinkIcon = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>;
        const Tag = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.5 16H2"/><path d="M22 7l-5-5L2 17l5 5z"/></svg>;
        const LayoutGrid = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="3" y1="15" x2="21" y2="15"/><line x1="9" y1="3" x2="9" y2="21"/><line x1="15" y1="3" x2="15" y2="21"/></svg>;
        const ArrowLeft = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19l-7-7 7-7"/><path d="M19 12H5"/></svg>;
        const AlertCircle = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12" y2="16"/></svg>;
        const Square = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>;
        const CheckSquare = (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><path d="M9 12l2 2 4-4"/></svg>;


        // --- UTILITY FUNCTIONS (Database Structure Management) ---

        // Function to attempt loading legacy projects from localStorage for migration
        const loadLegacyProjects = () => {
            try {
                const stored = localStorage.getItem(CATEGORY_STORAGE_KEY);
                return stored ? JSON.parse(stored) : null;
            } catch (e) {
                console.error("Error loading legacy projects from localStorage:", e);
                return null;
            }
        };

        const getStructureFromDB = async (client) => {
            if (!client) return null;
            try {
                const { data, error } = await client
                    .from(STRUCTURE_TABLE)
                    .select('structure_map')
                    .eq('id', STRUCTURE_ROW_ID)
                    .single();

                if (error && error.code !== 'PGRST116') { 
                    console.warn("DB Structure Fetch Warning:", error.message);
                }
                return data?.structure_map || null; 

            } catch (e) {
                console.error("Error fetching structure from DB:", e);
                return null;
            }
        };

        const saveStructureToDB = async (client, map) => {
            if (!client) return false;
            try {
                const { error } = await client
                    .from(STRUCTURE_TABLE)
                    .upsert({ id: STRUCTURE_ROW_ID, structure_map: map }, { onConflict: 'id' });

                if (error) {
                    console.error("Error saving structure to DB:", error);
                    return false;
                }
                return true;
            } catch (e) {
                console.error("Error saving structure to DB:", e);
                return false;
            }
        };
        
        const clearAllSnagsFromDB = async (client, totalCount, setStatus) => {
            if (!client) {
                setStatus('Error: Cannot clear database, Supabase client is not initialized.');
                return;
            }
            
            setStatus(`Deleting ${totalCount} orphaned entries...`);

            // Delete all rows in the snags table using a dummy condition
            const { error } = await client
                .from(TABLE_NAME)
                .delete()
                .neq('id', '0'); 

            if (error) {
                console.error("Error clearing all snags:", error);
                setStatus(`Failed to clear all snags: ${error.message}`);
            } else {
                // CRITICAL FIX: Explicitly re-fetch after clearing to update the total count immediately
                await client.from(TABLE_NAME).select('*'); 
                setStatus(`Successfully cleared ALL ${totalCount} orphaned entries from the database.`);
            }
        };

        const updateRelatedSnags = async (client, type, oldName, newName, parentProject) => {
            if (!client || !oldName || !newName || oldName === newName) return true;

            let updateData = {};
            let query = client.from(TABLE_NAME);

            if (type === 'project') {
                updateData = { header_category: newName };
                query = query.update(updateData).eq('header_category', oldName);
            } else if (type === 'group' && parentProject) {
                updateData = { room_name: newName };
                query = query.update(updateData).eq('header_category', parentProject).eq('room_name', oldName);
            } else {
                return true; // No operation needed
            }

            const { error } = await query;

            if (error) {
                console.error(`Error updating snags for ${type} rename:`, error);
                return false;
            }
            return true;
        };


        const renderMarkdownLinks = (text) => {
            if (!text) return { __html: '' };
            const regex = /\[([^\]]+)\]\(([^)]+)\)/g;
            
            const htmlText = text.replace(regex, (match, linkText, url) => {
                let safeUrl = url.trim();
                if (!safeUrl.match(/^(https?:\/\/|mailto:)/i)) {
                    safeUrl = 'http://' + safeUrl;
                }
                return `<a href="${safeUrl}" target="_blank" rel="noopener noreferrer">${linkText}</a>`;
            });

            return { __html: htmlText };
        };


        function Tracker() {
            const [snags, setSnags] = useState([]);
            
            // Structure Management State
            const [allGroupsMap, setAllGroupsMap] = useState({});
            const allProjects = useMemo(() => Object.keys(allGroupsMap).sort(), [allGroupsMap]);
            const totalSnagsCount = snags.length; 

            // UI State for the navigation
            const [selectedProject, setSelectedProject] = useState('');
            const [selectedGroup, setSelectedGroup] = useState('');
            
            // MOBILE State: 'projects', 'groups', 'items'
            const [activePanel, setActivePanel] = useState('projects'); 
            const [isDesktop, setIsDesktop] = useState(window.innerWidth >= 1024);
            
            useEffect(() => {
                const handleResize = () => setIsDesktop(window.innerWidth >= 1024);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);


            // Modal States
            const [modal, setModal] = useState(null); 
            const [linkModal, setLinkModal] = useState(null); 
            const [isAddSnagModalOpen, setIsAddSnagModalOpen] = useState(false); 
            const [viewingPhoto, setViewingPhoto] = useState(null);
            
            // New Item Form State (initialized to first available values)
            const [newProjectCategory, setNewProjectCategory] = useState('');
            const [newProjectGroup, setNewProjectGroup] = useState('');

            // Editing Item State 
            const [editingSnagId, setEditingSnagId] = useState(null);

            // System State
            const [status, setStatus] = useState('Awaiting connection...');
            const [supabaseClient, setSupabaseClient] = useState(null);
            

            // --- SUPABASE INITIALIZATION & LISTENER ---

            useEffect(() => {
                if (SUPABASE_ANON_KEY.includes('PASTE_')) {
                    setStatus('Error: Supabase ANONYMOUS KEY is missing. Please enter it in the CONFIGURATION section.');
                    return;
                }
                
                try {
                    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    setSupabaseClient(client);
                    setStatus('Client initialized...');
                } catch (error) {
                    console.error("Supabase Initialization Error:", error);
                    setStatus(`Initialization Error: ${error.message}`);
                }
            }, []);
            
            // --- NEW: Calculate open snags by Group/Room ---
            const openSnagsByGroup = useMemo(() => {
                const counts = {}; // { 'ProjectA|Group1': 5, ... }

                snags.forEach(snag => {
                    if (snag.status === 'open') {
                        const key = `${snag.header_category}|${snag.room_name}`;
                        counts[key] = (counts[key] || 0) + 1;
                    }
                });
                return counts;
            }, [snags]);


            const fetchSnags = useCallback(async (client) => {
                if (!client) return;

                setStatus('Fetching structure and data...');
                
                // --- 1. Fetch Structure from DB (or migrate if necessary) ---
                let structureMap = await getStructureFromDB(client); 
                
                if (!structureMap) {
                    const localData = loadLegacyProjects();
                    if (localData && Object.keys(localData).length > 0) {
                        structureMap = localData;
                        setStatus('Migrating project structure...');
                    } else {
                        structureMap = INITIAL_PROJECTS;
                    }

                    if (await saveStructureToDB(client, structureMap)) {
                        localStorage.removeItem(CATEGORY_STORAGE_KEY);
                    }
                }
                
                setAllGroupsMap(structureMap);

                // --- 2. Fetch Snags ---
                const { data, error } = await client
                    .from(TABLE_NAME)
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error("Fetch Snags Error:", error);
                    setStatus(`Error fetching data: ${error.message}`);
                    return;
                }

                setSnags(data);
                setStatus(`Sync successful. ${data.length} items. Structure synced.`);

                // --- 3. Update Selections and Defaults (Stability Fix) ---
                const projects = Object.keys(structureMap).sort();
                
                // Use the latest state values for non-conflicting check
                const currentProject = client._selectionProject || '';
                const currentGroup = client._selectionGroup || '';
                
                let projectToSelect = currentProject;
                let groupToSelect = currentGroup;

                // Check if the currently selected project is still valid.
                if (!projectToSelect || !projects.includes(projectToSelect)) {
                    projectToSelect = projects[0] || '';
                } 

                if (projectToSelect) {
                    const currentGroups = structureMap[projectToSelect] || [];
                    // Check if the currently selected group is still valid under the newly validated/selected project.
                    if (!groupToSelect || !currentGroups.includes(groupToSelect)) {
                        groupToSelect = currentGroups[0] || '';
                    }
                } else {
                    groupToSelect = '';
                }

                // ONLY set state if the calculated values are different from the current state values
                // This prevents endless re-runs of the selection logic if the state is already correct
                if (projectToSelect !== currentProject) {
                    setSelectedProject(projectToSelect);
                }
                if (groupToSelect !== currentGroup) {
                    setSelectedGroup(groupToSelect);
                }
                
                // Also update the hidden values on the client instance so the next run of fetchSnags sees them
                client._selectionProject = projectToSelect;
                client._selectionGroup = groupToSelect;
                
                // Set defaults for the Add Snag Modal if the app is starting/uninitialized
                if (!newProjectCategory) { 
                    const firstProj = projects[0] || '';
                    setNewProjectCategory(firstProj);
                    setNewProjectGroup(structureMap[firstProj]?.[0] || '');
                }


            // STABILITY FIX: Remove selectedProject/selectedGroup from dependency array to prevent re-fetch loop
            }, [supabaseClient, newProjectCategory]); 

            useEffect(() => {
                if (!supabaseClient) return;
                
                // Initialize hidden state on client instance for stability fix
                supabaseClient._selectionProject = '';
                supabaseClient._selectionGroup = '';
                
                fetchSnags(supabaseClient);

                // Listen to Snags table changes
                const snagSubscription = supabaseClient
                    .channel('public:snags_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: TABLE_NAME }, payload => {
                        // When data changes, re-fetch and re-run selection logic
                        fetchSnags(supabaseClient);
                    })
                    .subscribe();

                // Listen to Structure table changes (for multi-user sync)
                const structureSubscription = supabaseClient
                    .channel('public:structure_updates')
                    .on('postgres_changes', { event: '*', schema: 'public', table: STRUCTURE_TABLE }, payload => {
                        fetchSnags(supabaseClient);
                    })
                    .subscribe();


                return () => {
                    if (snagSubscription) {
                        supabaseClient.removeChannel(snagSubscription);
                    }
                    if (structureSubscription) {
                         supabaseClient.removeChannel(structureSubscription);
                    }
                };
            }, [supabaseClient, fetchSnags]);


            // --- STRUCTURE MANAGEMENT (PROJECTS & GROUPS) ---

            const structureAction = (type, action, currentName = '', parentProject = '') => {
                
                const handleStructureChange = async (newName) => {
                    const newMap = JSON.parse(JSON.stringify(allGroupsMap));
                    let shouldResetSelection = false;
                    
                    if (type === 'project') {
                        if (action === 'add' && newName) {
                            newMap[newName] = [];
                        } else if (action === 'edit' && newName && newName !== currentName) {
                            // FIX: Update all related snag items before changing the structure map
                            const snagsUpdated = await updateRelatedSnags(supabaseClient, 'project', currentName, newName, null);
                            if (!snagsUpdated) {
                                setStatus('Error: Failed to update associated items. Structure not saved.');
                                return; // Abort on failure
                            }
                            newMap[newName] = newMap[currentName] || [];
                            delete newMap[currentName];
                            if (selectedProject === currentName) {
                                setSelectedProject(newName); // Keep the new selection
                                supabaseClient._selectionProject = newName; // Update hidden state
                            }
                        } else if (action === 'delete') {
                            delete newMap[currentName];
                            // Force selection update on delete
                            setSelectedProject('');
                            setSelectedGroup('');
                            supabaseClient._selectionProject = '';
                            supabaseClient._selectionGroup = '';
                            shouldResetSelection = true;
                        }
                    } else if (type === 'group' && parentProject) {
                        let groups = newMap[parentProject] || [];
                        
                        if (action === 'add' && newName) {
                            if (!groups.includes(newName)) groups.push(newName);
                        } else if (action === 'edit' && newName && newName !== currentName) {
                             // FIX: Update all related snag items before changing the structure map
                            const snagsUpdated = await updateRelatedSnags(supabaseClient, 'group', currentName, newName, parentProject);
                            if (!snagsUpdated) {
                                setStatus('Error: Failed to update associated items. Structure not saved.');
                                return; // Abort on failure
                            }
                            const index = groups.indexOf(currentName);
                            if (index !== -1) groups[index] = newName;
                            if (selectedGroup === currentName) {
                                setSelectedGroup(newName); // Keep the new selection
                                supabaseClient._selectionGroup = newName; // Update hidden state
                            }
                        } else if (action === 'delete') {
                            newMap[parentProject] = groups.filter(s => s !== currentName);
                            // Force group update on delete
                            if (currentName === selectedGroup) {
                                setSelectedGroup('');
                                supabaseClient._selectionGroup = '';
                                shouldResetSelection = true;
                            }
                        }
                        // Sort for cleanliness
                        newMap[parentProject].sort();
                    }
                    
                    // 1. Update local state immediately for responsiveness
                    setAllGroupsMap(newMap);
                    
                    // 2. Save to database
                    setStatus('Saving structure to database...');
                    const success = await saveStructureToDB(supabaseClient, newMap);
                    
                    if (!success) {
                        setStatus('Error: Failed to save project structure to database.');
                    } else {
                        setStatus('Structure saved. Syncing...');
                    }
                    
                    // 3. Trigger re-fetch to ensure all components are synced and filters are reset correctly
                    // We call fetchSnags directly instead of relying on the listener which might be delayed
                    fetchSnags(supabaseClient);
                }

                // If deleting, show the confirm modal first
                if (action === 'delete') {
                    const structureName = type === 'group' ? 'Room' : 'Project';
                    const message = `Are you sure you want to delete the ${structureName.toLowerCase()} **${currentName}**? 
                                    This will permanently remove it from the synced structure for all users. 
                                    Note: The actual snag items in the database will NOT be deleted and will become inaccessible via this filter.`;
                    
                    setModal({
                        type: 'confirm',
                        message: message,
                        action: () => modal.handler(currentName),
                        handler: handleStructureChange // Pass the inner handler to the modal
                    });
                } else {
                    // For add/edit, show the input modal
                     setModal({
                        type: 'structure',
                        actionType: action, // 'add', 'edit', 'delete'
                        structureType: type, // 'project', 'group'
                        currentName: currentName,
                        parentProject: parentProject,
                        handler: handleStructureChange
                    });
                }
            };


            // --- SUPABASE CRUD WRAPPERS ---
            const addNewSnagToDB = async (snagData) => {
                if (!supabaseClient) return setStatus('Connection not ready.');
                
                const { error } = await supabaseClient
                    .from(TABLE_NAME)
                    .insert([{ 
                        ...snagData,
                        status: 'open',
                        created_at: new Date().toISOString(),
                    }]);

                if (error) {
                    console.error("Error adding item:", error);
                    setStatus(`Failed to add item: ${error.message}`);
                } else {
                    // fetchSnags called via listener
                    setStatus('Item added successfully. Syncing...');
                    
                    setIsAddSnagModalOpen(false); 

                    if (!isDesktop) {
                        setActivePanel('items');
                    }
                }
            };

            const updateSnagInDB = async (id, updates) => {
                if (!supabaseClient) return setStatus('Connection not ready.');

                const { error } = await supabaseClient
                    .from(TABLE_NAME)
                    .update(updates)
                    .eq('id', id);

                if (error) {
                    console.error("Error updating item:", error);
                    setStatus(`Failed to update item: ${error.message}`);
                } else {
                    setStatus('Item updated. Syncing...');
                }
            };

            const deleteSnagFromDB = async (id) => {
                if (!supabaseClient) return setStatus('Connection not ready.');

                const { error } = await supabaseClient
                    .from(TABLE_NAME)
                    .delete()
                    .eq('id', id);

                if (error) {
                    console.error("Error deleting item:", error);
                    setStatus(`Failed to delete item: ${error.message}`);
                } else {
                    setStatus('Item deleted. Syncing...');
                }
            };

            const handleClearDatabase = () => {
                setModal({
                    type: 'confirm',
                    message: `WARNING! You are about to permanently delete **${totalSnagsCount}** items from the database's \`${TABLE_NAME}\` table. This action cannot be undone.`,
                    action: () => clearAllSnagsFromDB(supabaseClient, totalSnagsCount, setStatus)
                });
            }


            // --- NAVIGATION AND FILTERING ---

            const handleProjectSelect = (project) => {
                setSelectedProject(project);
                supabaseClient._selectionProject = project; // Update hidden state
                const newGroups = allGroupsMap[project] || [];
                const newGroup = newGroups[0] || '';
                setSelectedGroup(newGroup);
                supabaseClient._selectionGroup = newGroup; // Update hidden state

                if (!isDesktop) {
                    setActivePanel('groups');
                }
            };

            const handleGroupSelect = (group) => {
                setSelectedGroup(group);
                supabaseClient._selectionGroup = group; // Update hidden state
                if (!isDesktop) {
                    setActivePanel('items');
                }
            };

            const navigateBack = (fromPanel) => {
                if (!isDesktop) {
                    if (fromPanel === 'items') {
                        setActivePanel('groups');
                    } else if (fromPanel === 'groups') {
                        setActivePanel('projects');
                    }
                }
            };

            const filteredSnags = useMemo(() => {
                // If there are no projects, show ALL snags (orphaned list) in the right panel if selectedProject is empty.
                if (allProjects.length === 0) {
                     return snags.sort((a, b) => {
                        // Closed tasks go to bottom
                        if (a.status === 'open' && b.status === 'closed') return -1;
                        if (a.status === 'closed' && b.status === 'open') return 1;
                        // Within same status, newest first
                        return new Date(b.created_at) - new Date(a.created_at);
                    });
                }


                if (!selectedProject || !selectedGroup) return [];

                let filtered = snags;

                filtered = filtered.filter(snag => (snag.header_category || 'Uncategorized') === selectedProject);
                filtered = filtered.filter(snag => (snag.room_name || 'N/A') === selectedGroup);
                
                return filtered.sort((a, b) => {
                    // Closed tasks go to bottom
                    if (a.status === 'open' && b.status === 'closed') return -1;
                    if (a.status === 'closed' && b.status === 'open') return 1;
                    // Within same status, newest first
                    return new Date(b.created_at) - new Date(a.created_at);
                });

            }, [snags, selectedProject, selectedGroup, allProjects.length]);

            const availableGroups = useMemo(() => {
                return selectedProject ? (allGroupsMap[selectedProject] || []) : [];
            }, [selectedProject, allGroupsMap]);


            const injectLink = (markdownLink, target) => {
                if (target === 'edit') {
                    setEditingSnagText(prev => prev.trim() + ' ' + markdownLink + ' ');
                }
                setLinkModal(null);
            };


            const handleAddItemClick = () => {
                if (allProjects.length === 0) {
                    setStatus('Please add a Project first before adding items.');
                    return;
                }
                
                if (selectedProject) {
                    setNewProjectCategory(selectedProject);
                    
                    if (selectedGroup) {
                        setNewProjectGroup(selectedGroup);
                    } else {
                        const defaultGroup = allGroupsMap[selectedProject]?.[0] || '';
                        setNewProjectGroup(defaultGroup);
                    }
                }
                setIsAddSnagModalOpen(true);
            };

            const addSnag = (snagText, project, group, photoData = null) => {
                if (!snagText.trim() || !project || !group) {
                    setStatus('Error: Missing item text, project, or group.');
                    return;
                }

                const newSnagData = {
                    header_category: project, 
                    room_name: group,         
                    text: snagText.trim(),
                    photo_data: photoData,
                };
                addNewSnagToDB(newSnagData);
            };

            const toggleSnagStatus = (snag) => {
                const newStatus = snag.status === 'closed' ? 'open' : 'closed';
                updateSnagInDB(snag.id, { status: newStatus });
            };

            const handleDeleteRequest = (snag) => {
                setModal({
                    type: 'confirm',
                    message: `Are you sure you want to delete: "${snag.text.split('[')[0].trim()}..."? This action cannot be undone.`,
                    action: () => deleteSnagFromDB(snag.id)
                });
            };
            
            const startEdit = (snag) => {
                setEditingSnagId(snag.id);
            }
            
            const saveEdit = (id, updatedData) => {
                updateSnagInDB(id, updatedData);
                setEditingSnagId(null);
            }


            // --- MODAL COMPONENTS ---

            const AddSnagModal = ({ isOpen, onClose, onAddSnag, setLinkModal, allGroupsMap, newProjectCategory, setNewProjectCategory, newProjectGroup, setNewProjectGroup }) => {
                const [snagText, setSnagText] = useState(''); 
                const [photoData, setPhotoData] = useState(null);
                const inputRef = useRef(null);

                // Auto-focus the text area when the modal opens
                useEffect(() => {
                    if (isOpen && inputRef.current) {
                        inputRef.current.focus();
                    }
                }, [isOpen]);

                if (!isOpen) return null;

                const allProjs = Object.keys(allGroupsMap).sort();
                const availableGroupsForProject = allGroupsMap[newProjectCategory] || [];
                const canSubmit = snagText.trim() && newProjectCategory && newProjectGroup;

                const injectLocalLink = (markdownLink) => {
                    setSnagText(prev => prev.trim() + ' ' + markdownLink + ' ');
                    setLinkModal(null);
                };

                const handleLinkClick = (e) => {
                    e.preventDefault();
                    setLinkModal({ 
                        type: 'link', 
                        target: 'new',
                        injectFn: injectLocalLink 
                    });
                };

                const handleSubmit = (e) => {
                    e.preventDefault();
                    onAddSnag(snagText, newProjectCategory, newProjectGroup, photoData);
                    setSnagText(''); 
                    setPhotoData(null);
                };

                const closeHandler = () => {
                    setSnagText(''); 
                    setPhotoData(null);
                    onClose();
                }

                return (
                    <div className="modal" onClick={closeHandler}>
                        <form className="modal-content" onClick={(e) => e.stopPropagation()} onSubmit={handleSubmit}>
                            <div className="flex items-center justify-between mb-4 border-b pb-3 border-slate-100">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center"><Plus className="w-5 h-5 mr-2 text-accent"/> Add New Project Item</h3>
                                <button type="button" onClick={closeHandler} className="p-1 text-slate-500 hover:text-slate-800 rounded-full"><X className="w-5 h-5" /></button>
                            </div>
                            
                            <div className="flex space-x-3 mb-4">
                                <select
                                    value={newProjectCategory}
                                    onChange={(e) => {
                                        setNewProjectCategory(e.target.value);
                                        const newGroups = allGroupsMap[e.target.value] || [];
                                        setNewProjectGroup(newGroups[0] || '');
                                    }}
                                    className="w-1/2 p-3 border border-slate-300 rounded-xl text-base bg-white focus:outline-none focus:ring-2 focus:ring-primary"
                                    required
                                >
                                    <option value="" disabled>Select Project</option>
                                    {allProjs.map(proj => (
                                        <option key={proj} value={proj}>{proj}</option>
                                    ))}
                                </select>
                                <select
                                    value={newProjectGroup}
                                    onChange={(e) => setNewProjectGroup(e.target.value)}
                                    className="w-1/2 p-3 border border-slate-300 rounded-xl text-base bg-white focus:outline-none focus:ring-2 focus:ring-accent"
                                    required
                                    disabled={!newProjectCategory || availableGroupsForProject.length === 0}
                                >
                                    <option value="" disabled>Select Room</option>
                                    {availableGroupsForProject.map(group => (
                                        <option key={group} value={group}>{group}</option>
                                    ))}
                                </select>
                            </div>

                            <label className="block text-sm font-medium text-slate-700 mb-1">Item Details</label>
                            <textarea
                                rows="3"
                                placeholder="Enter item details (supports [link text](url))"
                                value={snagText}
                                onChange={(e) => setSnagText(e.target.value)}
                                className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-3 text-base"
                                required
                                ref={inputRef} 
                            />

                            <input
                                type="file"
                                accept="image/*"
                                capture="environment"
                                onChange={(e) => {
                                    const file = e.target.files[0];
                                    if (file) {
                                        const reader = new FileReader();
                                        reader.onloadend = () => setPhotoData(reader.result);
                                        reader.readAsDataURL(file);
                                    }
                                }}
                                className="hidden"
                                id="new-photo-upload"
                            />
                            {photoData && (
                                <div className="mb-3 relative">
                                    <img src={photoData} alt="Preview" className="w-full h-32 object-cover rounded-lg border-2 border-slate-300"/>
                                    <button
                                        type="button"
                                        onClick={() => setPhotoData(null)}
                                        className="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full hover:bg-red-600"
                                        title="Remove Photo"
                                    >
                                        <X className="w-4 h-4"/>
                                    </button>
                                </div>
                            )}

                            <div className="flex justify-between items-center mb-6">
                                <div className="flex space-x-2">
                                    <button
                                        type="button"
                                        onClick={handleLinkClick}
                                        className="px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-xl text-sm flex items-center shadow-sm"
                                        title="Add a clickable link to the snag text"
                                    >
                                        <LinkIcon className="w-4 h-4 mr-1" /> Embed Link
                                    </button>
                                    <label
                                        htmlFor="new-photo-upload"
                                        className="px-3 py-2 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-xl text-sm flex items-center shadow-sm cursor-pointer"
                                        title="Add a photo"
                                    >
                                        <Camera className="w-4 h-4 mr-1" /> Add Photo
                                    </label>
                                </div>
                                <button
                                    type="submit"
                                    className="px-6 py-2.5 bg-accent text-white font-bold rounded-xl shadow-md hover:bg-green-600 transition disabled:opacity-50"
                                    disabled={!canSubmit || !supabaseClient}
                                >
                                    Submit Item
                                </button>
                            </div>
                        </form>
                    </div>
                );
            };

            const CustomModal = ({ modal, closeModal }) => {
                const inputRef = useRef(null);
                
                // Auto-focus for structure modal
                useEffect(() => {
                    if (modal?.type === 'structure' && inputRef.current) {
                        inputRef.current.focus();
                    }
                }, [modal]);

                if (!modal) return null;

                const handleAction = () => {
                    // Call the handler provided in the modal state
                    if (modal.handler) {
                        modal.handler(modal.inputValue || modal.currentName); // Pass input or current name
                    } else if (modal.action) {
                         // Fallback for simple actions like clearDatabase
                        modal.action();
                    }
                    setModal(null); 
                };

                // Confirmation Modal (Delete Snag Item / Delete Structure Item / Clear DB)
                if (modal.type === 'confirm') {
                    return (
                        <div className="modal" onClick={closeModal}>
                            <div className="modal-content transform transition-all" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center space-x-3 mb-4 border-b pb-3 border-slate-100">
                                    <Trash className="w-6 h-6 text-red-500"/>
                                    <h3 className="text-xl font-bold text-slate-800">Confirm Action</h3>
                                </div>
                                <p className="text-slate-600 mb-8" dangerouslySetInnerHTML={{__html: modal.message}}></p>
                                <div className="flex justify-end space-x-3">
                                    <button
                                        onClick={closeModal}
                                        className="px-6 py-2.5 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 transition shadow-sm"
                                    >
                                        Cancel
                                    </button>
                                    <button
                                        onClick={handleAction}
                                        className="px-6 py-2.5 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition shadow-md"
                                    >
                                        Confirm
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                // Status View Modal
                if (modal.type === 'status_view') {
                    return (
                        <div className="modal" onClick={closeModal}>
                            <div className="modal-content !max-w-xl" onClick={(e) => e.stopPropagation()}>
                                <div className="flex items-center space-x-3 mb-4 border-b pb-3 border-slate-100">
                                    <h3 className="text-xl font-bold text-slate-800">System Status / Error Log</h3>
                                </div>
                                <p className="text-slate-600 whitespace-pre-wrap break-words max-h-96 overflow-y-auto mb-4 p-2 bg-slate-50 rounded-lg border border-slate-200">{modal.message}</p>
                                <div className="flex justify-end">
                                    <button
                                        onClick={closeModal}
                                        className="px-6 py-2.5 bg-primary text-white font-semibold rounded-xl hover:bg-blue-900 transition shadow-md"
                                    >
                                        Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }


                // Structure Management Modal (Add/Edit Project/Group)
                if (modal.type === 'structure') {
                    const [inputValue, setInputValue] = useState(modal.currentName || '');
                    const isAdd = modal.actionType === 'add';
                    const structureName = modal.structureType === 'group' ? 'Room' : 'Project';
                    const title = isAdd ? `Add New ${structureName}` : `Rename ${structureName}: ${modal.currentName}`;
                    const placeholder = `Enter new ${structureName.toLowerCase()} name...`;
                    
                    const handleStructureSubmit = (e) => {
                        e.preventDefault();
                        if (inputValue.trim()) {
                            // Call the handler with the new value
                            modal.handler(inputValue.trim());
                            setModal(null);
                        } else {
                            setStatus(`Error: ${structureName} name cannot be empty.`);
                        }
                    };

                    return (
                        <div className="modal" onClick={closeModal}>
                            <form className="modal-content" onClick={(e) => e.stopPropagation()} onSubmit={handleStructureSubmit}>
                                <div className="flex items-center justify-between mb-4 border-b pb-3 border-slate-100">
                                    <h3 className="text-xl font-bold text-slate-800 flex items-center">
                                        {isAdd ? <Plus className="w-5 h-5 mr-2 text-accent"/> : <Edit className="w-5 h-5 mr-2 text-primary"/>}
                                        {title}
                                    </h3>
                                    <button type="button" onClick={closeModal} className="p-1 text-slate-500 hover:text-slate-800 rounded-full"><X className="w-5 h-5" /></button>
                                </div>
                                
                                <label className="block text-sm font-medium text-slate-700 mb-1">New Name</label>
                                <input
                                    type="text"
                                    placeholder={placeholder}
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-6 text-base"
                                    required
                                    ref={inputRef} 
                                />

                                <div className="flex justify-end">
                                    <button
                                        type="submit"
                                        className="px-6 py-2.5 bg-primary text-white font-bold rounded-xl shadow-md hover:bg-blue-900 transition disabled:opacity-50"
                                        disabled={!inputValue.trim()}
                                    >
                                        {isAdd ? 'Add' : 'Save'} {structureName}
                                    </button>
                                </div>
                            </form>
                        </div>
                    );
                }

                return null;
            };

            const LinkModal = ({ linkModal, setLinkModal }) => {
                const linkTextRef = useRef(null);

                // Auto-focus the link text input when the modal opens
                useEffect(() => {
                    if (linkModal && linkTextRef.current) {
                        linkTextRef.current.focus();
                    }
                }, [linkModal]);

                if (!linkModal) return null;

                const [linkText, setLinkText] = useState('');
                const [url, setUrl] = useState('');

                const handleLinkSubmit = (e) => {
                    e.preventDefault();
                    if (linkText.trim() && url.trim()) {
                        const markdownLink = `[${linkText.trim()}](${url.trim()})`;
                        linkModal.injectFn(markdownLink, linkModal.target);
                        setLinkModal(null);
                    }
                };

                const closeModal = () => setLinkModal(null);

                return (
                    <div className="modal" onClick={closeModal}>
                        <form className="modal-content" onClick={(e) => e.stopPropagation()} onSubmit={handleLinkSubmit}>
                            <div className="flex items-center justify-between mb-4 border-b pb-3 border-slate-100">
                                <h3 className="text-xl font-bold text-slate-800 flex items-center"><LinkIcon className="w-5 h-5 mr-2 text-primary"/> Embed Markdown Link</h3>
                                <button type="button" onClick={closeModal} className="p-1 text-slate-500 hover:text-slate-800 rounded-full"><X className="w-5 h-5" /></button>
                            </div>
                            
                            <label className="block text-sm font-medium text-slate-700 mb-1">Link Text (What the user clicks)</label>
                            <input
                                type="text"
                                placeholder="e.g., View PDF document"
                                value={linkText}
                                onChange={(e) => setLinkText(e.target.value)}
                                className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-4 text-base"
                                required
                                ref={linkTextRef} 
                            />
                            
                            <label className="block text-sm font-medium text-slate-700 mb-1">URL (The link destination)</label>
                            <input
                                type="url"
                                placeholder="e.g., https://example.com/document.pdf"
                                value={url}
                                onChange={(e) => setUrl(e.target.value)}
                                className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-6 text-base"
                                required
                            />

                            <div className="flex justify-end">
                                <button
                                    type="submit"
                                    className="px-6 py-2.5 bg-primary text-white font-bold rounded-xl shadow-md hover:bg-blue-900 transition disabled:opacity-50"
                                    disabled={!linkText.trim() || !url.trim()}
                                >
                                    Embed Link
                                </button>
                            </div>
                        </form>
                    </div>
                );
            };

            
            // --- UI COMPONENTS ---

            const ProjectPanel = ({ active, allProjects, selectedProject, onSelect, structureAction, totalSnagsCount, supabaseClient, handleClearDatabase }) => {
                const isOrphanMode = allProjects.length === 0;
                const canClearOrphans = isOrphanMode && supabaseClient;

                return (
                    <div className={`panel project-panel ${active ? 'active-panel' : 'hidden-right'}`} id="projects-panel">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-white">
                             {/* TITLE COUNT REMOVED: Projects (X) changed to Projects */}
                            <h2 className="text-xl font-extrabold text-slate-800 flex items-center">
                                <LayoutGrid className="w-5 h-5 mr-2 text-primary"/> Projects
                            </h2>
                            <button 
                                onClick={() => structureAction('project', 'add')} 
                                className="p-2 bg-accent text-white rounded-full shadow-md hover:bg-green-600 transition"
                                title="Add New Project"
                            >
                                <Plus className="w-5 h-5"/>
                            </button>
                        </div>
                        <div className="panel-list-wrapper">
                            {isOrphanMode ? (
                                <div className="p-4 text-center text-slate-500">
                                    <p className="mb-2 font-semibold">No Projects defined yet.</p>
                                    <p className="text-sm">Start by clicking the **+** button above to add your first project, or continue below.</p>
                                </div>
                            ) : (
                                allProjects.map(project => (
                                    <div key={project} 
                                        onClick={() => onSelect(project)}
                                        className={`px-4 py-3 border-b border-slate-100 cursor-pointer transition flex justify-between items-center ${selectedProject === project ? 'bg-blue-100 font-bold text-primary' : 'hover:bg-slate-50 text-slate-700'}`}
                                    >
                                        <span className="truncate">{project}</span>
                                        <div className="flex space-x-2">
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); structureAction('project', 'edit', project); }}
                                                className="p-1 rounded-full text-slate-500 hover:text-primary hover:bg-slate-200 transition"
                                                title="Rename Project"
                                            >
                                                <Edit className="w-4 h-4"/>
                                            </button>
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); structureAction('project', 'delete', project); }}
                                                className="p-1 rounded-full text-slate-500 hover:text-red-600 hover:bg-slate-200 transition"
                                                title="Delete Project"
                                            >
                                                <Trash className="w-4 h-4"/>
                                            </button>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                        {canClearOrphans && (
                            <div className="p-4 border-t border-red-200 bg-red-50">
                                <button
                                    onClick={handleClearDatabase}
                                    className="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition flex items-center justify-center text-sm"
                                    title="Clear database items that are not attached to a Project/Room structure."
                                >
                                    <Trash className="w-4 h-4 mr-2"/>
                                    Clear Orphaned Entries ({totalSnagsCount})
                                </button>
                            </div>
                        )}
                        <Footer status={status} setModal={setModal} version={APP_VERSION} supabaseClient={supabaseClient}/>
                    </div>
                );
            };

            const GroupPanel = ({ active, selectedProject, availableGroups, selectedGroup, onSelect, structureAction, navigateBack, openSnagsByGroup }) => {
                const groupCount = availableGroups.length;

                return (
                    <div className={`panel group-panel ${active ? 'active-panel' : 'hidden-right'}`} id="groups-panel">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-white">
                            <button onClick={() => navigateBack('groups')} className="lg:hidden text-primary p-1 rounded-full hover:bg-slate-100 mr-2">
                                <ArrowLeft className="w-6 h-6"/>
                            </button>
                             {/* TITLE COUNT REMOVED: Rooms (X) changed to Rooms */}
                            <h2 className="text-xl font-extrabold text-slate-800 truncate flex-grow">
                                <Tag className="w-5 h-5 mr-2 text-primary inline-block"/>
                                {selectedProject ? `${selectedProject} / Rooms` : 'Select a Project'}
                            </h2>
                            <button 
                                onClick={() => selectedProject && structureAction('group', 'add', '', selectedProject)} 
                                className={`p-2 bg-accent text-white rounded-full shadow-md hover:bg-green-600 transition ${!selectedProject ? 'opacity-50 cursor-not-allowed' : ''}`}
                                title="Add New Room/Group"
                                disabled={!selectedProject}
                            >
                                <Plus className="w-5 h-5"/>
                            </button>
                        </div>
                        <div className="panel-list-wrapper">
                            {selectedProject && groupCount > 0 ? (
                                availableGroups.map(group => {
                                    const key = `${selectedProject}|${group}`;
                                    const openCount = openSnagsByGroup[key] || 0;
                                    const hasOpen = openCount > 0;

                                    return (
                                        <div key={group} 
                                            onClick={() => onSelect(group)}
                                            className={`px-4 py-3 border-b border-slate-100 cursor-pointer transition flex justify-between items-center ${selectedGroup === group ? 'bg-blue-100 font-bold text-primary' : 'hover:bg-slate-50 text-slate-700'}`}
                                        >
                                            <span className="truncate flex items-center">
                                                {group}
                                                {/* NEW: Display Open Snag Count */}
                                                {hasOpen && (
                                                    <span className="ml-3 px-2 py-0.5 text-xs font-bold text-white bg-status-open rounded-full shadow-inner flex items-center">
                                                        <AlertCircle className="w-3 h-3 mr-1"/>
                                                        {openCount}
                                                    </span>
                                                )}
                                            </span>
                                            <div className="flex space-x-2">
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); structureAction('group', 'edit', group, selectedProject); }}
                                                    className="p-1 rounded-full text-slate-500 hover:text-primary hover:bg-slate-200 transition"
                                                    title="Rename Room"
                                                >
                                                    <Edit className="w-4 h-4"/>
                                                </button>
                                                <button 
                                                    onClick={(e) => { e.stopPropagation(); structureAction('group', 'delete', group, selectedProject); }}
                                                    className="p-1 rounded-full text-slate-500 hover:text-red-600 hover:bg-slate-200 transition"
                                                    title="Delete Room"
                                                >
                                                    <Trash className="w-4 h-4"/>
                                                </button>
                                            </div>
                                        </div>
                                    );
                                })
                            ) : selectedProject && (
                                <div className="p-4 text-center text-slate-500">
                                    <p className="mb-2 font-semibold">No Rooms defined for this Project.</p>
                                    <p className="text-sm">Click the **+** button above to add your first room/area.</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const ItemsPanel = ({ active, filteredSnags, selectedProject, selectedGroup, toggleStatus, startEdit, viewingPhoto, setViewingPhoto, navigateBack, allProjects }) => {
                // TITLE COUNT REMOVED: Item count removed from title
                const title = allProjects.length === 0 ? 'All Orphaned Items' : `${selectedProject} / ${selectedGroup}`;

                return (
                    <div className={`panel items-panel ${active ? 'active-panel' : 'hidden-right'}`} id="items-panel">
                        <div className="p-4 border-b border-slate-200 flex justify-between items-center bg-white">
                            <button onClick={() => navigateBack('items')} className="lg:hidden text-primary p-1 rounded-full hover:bg-slate-100 mr-2">
                                <ArrowLeft className="w-6 h-6"/>
                            </button>
                            <h2 className="text-xl font-extrabold text-slate-800 flex-grow truncate">{title}</h2>
                            <button 
                                onClick={handleAddItemClick} 
                                className={`p-2 bg-primary text-white rounded-full shadow-md hover:bg-blue-900 transition ${!selectedGroup && allProjects.length > 0 ? 'opacity-50 cursor-not-allowed' : ''}`}
                                title="Add New Snag Item"
                                disabled={!selectedGroup && allProjects.length > 0}
                            >
                                <Plus className="w-5 h-5"/>
                            </button>
                        </div>
                        <div className="panel-list-wrapper p-4 space-y-4">
                            {filteredSnags.length === 0 ? (
                                <div className="p-8 text-center bg-slate-50 rounded-xl">
                                    <p className="text-slate-500 font-semibold mb-2">No items found.</p>
                                    {allProjects.length > 0 && <p className="text-sm text-slate-400">Click the **+** button to add your first snag item to this room.</p>}
                                </div>
                            ) : (
                                filteredSnags.map(snag => (
                                    <SnagCard 
                                        key={snag.id} 
                                        snag={snag} 
                                        toggleStatus={toggleSnagStatus} 
                                        handleDeleteRequest={handleDeleteRequest} 
                                        startEdit={startEdit}
                                        editingSnagId={editingSnagId}
                                        saveEdit={saveEdit}
                                        allGroupsMap={allGroupsMap}
                                        setLinkModal={setLinkModal}
                                        setViewingPhoto={setViewingPhoto}
                                        isOrphanMode={allProjects.length === 0}
                                    />
                                ))
                            )}
                        </div>
                        <ViewPhotoModal photoData={viewingPhoto} onClose={() => setViewingPhoto(null)}/>
                        <AddSnagModal 
                            isOpen={isAddSnagModalOpen} 
                            onClose={() => setIsAddSnagModalOpen(false)} 
                            onAddSnag={addSnag}
                            setLinkModal={setLinkModal}
                            allGroupsMap={allGroupsMap}
                            newProjectCategory={newProjectCategory}
                            setNewProjectCategory={setNewProjectCategory}
                            newProjectGroup={newProjectGroup}
                            setNewProjectGroup={setNewProjectGroup}
                        />
                    </div>
                );
            };

            const SnagCard = ({ snag, toggleStatus, handleDeleteRequest, startEdit, editingSnagId, saveEdit, allGroupsMap, setLinkModal, setViewingPhoto, isOrphanMode }) => {
                const isEditing = editingSnagId === snag.id;
                const statusColor = snag.status === 'open' ? 'bg-status-open' : 'bg-status-closed';
                const statusText = snag.status === 'open' ? 'OPEN' : 'CLOSED';
                
                // Local state for editing to prevent focus loss
                const [editedText, setEditedText] = useState('');
                const [editedProject, setEditedProject] = useState('');
                const [editedGroup, setEditedGroup] = useState('');
                const [editedPhoto, setEditedPhoto] = useState(null);

                useEffect(() => {
                    if (isEditing) {
                        setEditedText(snag.text || '');
                        setEditedProject(snag.header_category || '');
                        setEditedGroup(snag.room_name || '');
                        setEditedPhoto(snag.photo_data || null);
                    }
                }, [isEditing, snag]);
                
                const allProjs = Object.keys(allGroupsMap).sort();
                const availableGroupsForProject = allGroupsMap[editedProject] || [];

                const injectLocalLink = (markdownLink) => {
                    setEditedText(prev => (prev || '').trim() + ' ' + markdownLink + ' ');
                    setLinkModal(null);
                };

                const handleLinkClick = (e) => {
                    e.preventDefault();
                    setLinkModal({ 
                        type: 'link', 
                        target: 'edit',
                        injectFn: injectLocalLink 
                    });
                };
                
                const handleSave = () => {
                    saveEdit(snag.id, { 
                        text: editedText.trim(),
                        header_category: editedProject,
                        room_name: editedGroup,
                        photo_data: editedPhoto
                    });
                };

                const isMissingCategory = !snag.header_category || !snag.room_name;
                const cardClasses = `snag-card p-4 rounded-xl transition-all ${snag.status === 'closed' ? 'bg-white border-l-8 border-status-closed opacity-80' : 'bg-white border-l-8 border-status-open'}`;

                return (
                    <div className={cardClasses}>
                        <div className="flex justify-between items-start mb-3">
                            <div className="flex flex-col">
                                <span className={`text-xs font-bold text-white px-2 py-0.5 rounded-full ${statusColor}`}>
                                    {statusText}
                                </span>
                                {isOrphanMode && (
                                    <span className="text-xs text-red-500 font-semibold mt-1">ORPHANED ITEM</span>
                                )}
                                {!isOrphanMode && isMissingCategory && (
                                    <span className="text-xs text-red-500 font-semibold mt-1">MISSING CATEGORY</span>
                                )}
                            </div>
                            <div className="flex space-x-2">
                                <button 
                                    onClick={() => toggleStatus(snag)}
                                    className={`p-1 rounded transition ${snag.status === 'open' ? 'text-slate-400 hover:text-green-600' : 'text-green-600 hover:text-green-700'}`}
                                    title={snag.status === 'open' ? 'Mark as Complete' : 'Reopen Task'}
                                >
                                    {snag.status === 'open' ? <Square className="w-5 h-5"/> : <CheckSquare className="w-5 h-5"/>}
                                </button>
                                {isEditing ? (
                                    <>
                                        <button 
                                            onClick={handleSave}
                                            className="p-1 rounded-full bg-accent text-white hover:bg-green-600 transition"
                                            title="Save Changes"
                                        >
                                            <Check className="w-4 h-4"/>
                                        </button>
                                        <button 
                                            onClick={() => setEditingSnagId(null)}
                                            className="p-1 rounded-full bg-slate-200 text-slate-700 hover:bg-slate-300 transition"
                                            title="Cancel Edit"
                                        >
                                            <X className="w-4 h-4"/>
                                        </button>
                                    </>
                                ) : (
                                    <button 
                                        onClick={() => startEdit(snag)}
                                        className="p-1 rounded-full text-slate-500 hover:bg-slate-200 transition"
                                        title="Edit Item"
                                    >
                                        <Edit className="w-4 h-4"/>
                                    </button>
                                )}
                                <button 
                                    onClick={() => handleDeleteRequest(snag)}
                                    className="p-1 rounded-full text-red-500 hover:bg-red-100 transition"
                                    title="Delete Item"
                                >
                                    <Trash className="w-4 h-4"/>
                                </button>
                            </div>
                        </div>

                        {isEditing ? (
                             <>
                                <div className="flex space-x-3 mb-4">
                                    <select
                                        value={editedProject}
                                        onChange={(e) => {
                                            setEditedProject(e.target.value);
                                            const newGroups = allGroupsMap[e.target.value] || [];
                                            setEditedGroup(newGroups[0] || '');
                                        }}
                                        className="w-1/2 p-2 border border-slate-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-primary"
                                        title="Project"
                                    >
                                        <option value="" disabled>Select Project</option>
                                        {allProjs.map(proj => (
                                            <option key={proj} value={proj}>{proj}</option>
                                        ))}
                                    </select>
                                    <select
                                        value={editedGroup}
                                        onChange={(e) => setEditedGroup(e.target.value)}
                                        className="w-1/2 p-2 border border-slate-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-accent"
                                        title="Room"
                                        disabled={!editedProject || availableGroupsForProject.length === 0}
                                    >
                                        <option value="" disabled>Select Room</option>
                                        {availableGroupsForProject.map(group => (
                                            <option key={group} value={group}>{group}</option>
                                        ))}
                                    </select>
                                </div>
                                <textarea
                                    rows="3"
                                    value={editedText}
                                    onChange={(e) => setEditedText(e.target.value)}
                                    className="w-full p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary mb-3 text-sm"
                                    required
                                />
                                <input
                                    type="file"
                                    accept="image/*"
                                    capture="environment"
                                    onChange={(e) => {
                                        const file = e.target.files[0];
                                        if (file) {
                                            const reader = new FileReader();
                                            reader.onloadend = () => setEditedPhoto(reader.result);
                                            reader.readAsDataURL(file);
                                        }
                                    }}
                                    className="hidden"
                                    id={`edit-photo-upload-${snag.id}`}
                                />
                                {editedPhoto && (
                                    <div className="mb-3 relative">
                                        <img src={editedPhoto} alt="Preview" className="w-full h-32 object-cover rounded-lg border-2 border-slate-300"/>
                                        <button
                                            type="button"
                                            onClick={() => setEditedPhoto(null)}
                                            className="absolute top-1 right-1 p-1 bg-red-500 text-white rounded-full hover:bg-red-600"
                                            title="Remove Photo"
                                        >
                                            <X className="w-4 h-4"/>
                                        </button>
                                    </div>
                                )}
                                <div className="flex space-x-2 mb-4">
                                    <button
                                        type="button"
                                        onClick={handleLinkClick}
                                        className="px-3 py-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg text-xs flex items-center shadow-sm"
                                        title="Add a clickable link to the snag text"
                                    >
                                        <LinkIcon className="w-4 h-4 mr-1" /> Embed Link
                                    </button>
                                    <label
                                        htmlFor={`edit-photo-upload-${snag.id}`}
                                        className="px-3 py-1 bg-purple-500 hover:bg-purple-600 text-white font-semibold rounded-lg text-xs flex items-center shadow-sm cursor-pointer"
                                        title="Add or change photo"
                                    >
                                        <Camera className="w-4 h-4 mr-1" /> {editedPhoto ? 'Change' : 'Add'} Photo
                                    </label>
                                </div>
                            </>
                        ) : (
                            <>
                                <p className={`text-xs text-slate-500 mb-1 font-semibold ${snag.status === 'closed' ? 'line-through' : ''}`}>
                                    {snag.header_category || 'N/A'} / {snag.room_name || 'N/A'}
                                </p>
                                <div 
                                    className={`snag-description text-base leading-relaxed break-words ${snag.status === 'closed' ? 'line-through text-slate-500' : 'text-slate-800'}`}
                                    dangerouslySetInnerHTML={renderMarkdownLinks(snag.text)}
                                />
                                {snag.photo_data && (
                                    <button 
                                        onClick={() => setViewingPhoto(snag.photo_data)}
                                        className="mt-3 px-3 py-1 bg-primary text-white text-xs font-semibold rounded-lg flex items-center hover:bg-blue-900 transition"
                                    >
                                        <Camera className="w-3 h-3 mr-1"/> View Photo
                                    </button>
                                )}
                            </>
                        )}
                    </div>
                );
            };

            const ViewPhotoModal = ({ photoData, onClose }) => {
                if (!photoData) return null;

                return (
                    <div className="modal" onClick={onClose}>
                        <div className="modal-content !max-w-4xl !w-auto" onClick={(e) => e.stopPropagation()}>
                            <div className="flex justify-between items-center mb-4 border-b pb-3 border-slate-100">
                                <h3 className="text-xl font-bold text-slate-800">Attached Image</h3>
                                <button type="button" onClick={onClose} className="p-1 text-slate-500 hover:text-slate-800 rounded-full"><X className="w-5 h-5" /></button>
                            </div>
                            <img 
                                src={photoData} 
                                alt="Attached Snag Item" 
                                className="max-w-full h-auto rounded-lg shadow-xl"
                                // Placeholder on error - though base64 shouldn't fail unless data is corrupted
                                onError={(e) => e.target.src='https://placehold.co/600x400/CCCCCC/333333?text=Image+Load+Error'}
                            />
                        </div>
                    </div>
                );
            };

            const Footer = ({ status, setModal, version, supabaseClient }) => (
                <div className="p-2 border-t border-slate-200 bg-slate-50 flex justify-between items-center text-xs text-slate-600">
                    <button onClick={() => setModal({ type: 'status_view', message: status })} className="hover:text-primary transition font-semibold truncate max-w-[60%] text-left">
                        Status: {status}
                    </button>
                    {/* Version number is clearly visible here */}
                    <span className="ml-2 font-mono text-slate-500">v{version}</span>
                </div>
            );


            // --- MAIN RENDER ---
            
            // Determine active panel for mobile view
            let projectActive = isDesktop || activePanel === 'projects';
            let groupActive = isDesktop ? true : activePanel === 'groups';
            let itemsActive = isDesktop ? true : activePanel === 'items';
            
            // Adjust visibility for non-desktop (mobile)
            if (!isDesktop) {
                 groupActive = activePanel === 'groups';
                 itemsActive = activePanel === 'items';
                 // If item or group is active, projects panel is hidden
                 projectActive = activePanel === 'projects';
            }


            return (
                <div className="main-content">
                    <ProjectPanel 
                        active={projectActive} 
                        allProjects={allProjects} 
                        selectedProject={selectedProject} 
                        onSelect={handleProjectSelect} 
                        structureAction={structureAction} 
                        totalSnagsCount={totalSnagsCount}
                        supabaseClient={supabaseClient}
                        handleClearDatabase={handleClearDatabase}
                    />
                    
                    <GroupPanel 
                        active={groupActive} 
                        selectedProject={selectedProject} 
                        availableGroups={availableGroups} 
                        selectedGroup={selectedGroup} 
                        onSelect={handleGroupSelect} 
                        structureAction={structureAction} 
                        navigateBack={navigateBack}
                        openSnagsByGroup={openSnagsByGroup} // Passed new data here
                    />

                    <ItemsPanel 
                        active={itemsActive} 
                        filteredSnags={filteredSnags} 
                        selectedProject={selectedProject} 
                        selectedGroup={selectedGroup} 
                        toggleStatus={toggleSnagStatus} 
                        startEdit={startEdit}
                        viewingPhoto={viewingPhoto}
                        setViewingPhoto={setViewingPhoto}
                        navigateBack={navigateBack}
                        allProjects={allProjects}
                    />

                    <CustomModal modal={modal} closeModal={() => setModal(null)}/>
                    <LinkModal linkModal={linkModal} setLinkModal={setLinkModal} />
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<Tracker />);

    </script>
</body>
</html>

